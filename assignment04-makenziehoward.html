<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Makenzie Howard">
<meta name="dcterms.date" content="2025-10-06">

<title>Assignment 04</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="assignment04-makenziehoward_files/libs/clipboard/clipboard.min.js"></script>
<script src="assignment04-makenziehoward_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="assignment04-makenziehoward_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="assignment04-makenziehoward_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="assignment04-makenziehoward_files/libs/quarto-html/popper.min.js"></script>
<script src="assignment04-makenziehoward_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="assignment04-makenziehoward_files/libs/quarto-html/anchor.min.js"></script>
<link href="assignment04-makenziehoward_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="assignment04-makenziehoward_files/libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="assignment04-makenziehoward_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="assignment04-makenziehoward_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="assignment04-makenziehoward_files/libs/bootstrap/bootstrap-591810064b9a63b13c87081b5e0fabb3.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul class="collapse">
  <li><a href="#load-the-dataset" id="toc-load-the-dataset" class="nav-link active" data-scroll-target="#load-the-dataset"><span class="header-section-number">1</span> Load the dataset</a></li>
  <li><a href="#pick-eda-columns-and-preview" id="toc-pick-eda-columns-and-preview" class="nav-link" data-scroll-target="#pick-eda-columns-and-preview"><span class="header-section-number">2</span> Pick EDA Columns and Preview</a></li>
  <li><a href="#clean-categoricals-and-imputations" id="toc-clean-categoricals-and-imputations" class="nav-link" data-scroll-target="#clean-categoricals-and-imputations"><span class="header-section-number">3</span> Clean Categoricals and imputations</a></li>
  <li><a href="#vectorize-state_name-and-min_edulevels_name" id="toc-vectorize-state_name-and-min_edulevels_name" class="nav-link" data-scroll-target="#vectorize-state_name-and-min_edulevels_name"><span class="header-section-number">4</span> Vectorize STATE_NAME and MIN_EDULEVELS_NAME</a></li>
  <li><a href="#traintest-split-with-seed" id="toc-traintest-split-with-seed" class="nav-link" data-scroll-target="#traintest-split-with-seed"><span class="header-section-number">5</span> Train/Test split with seed</a></li>
  <li><a href="#linear-regression-model-ols-prep-and-training" id="toc-linear-regression-model-ols-prep-and-training" class="nav-link" data-scroll-target="#linear-regression-model-ols-prep-and-training"><span class="header-section-number">6</span> Linear Regression Model (OLS) Prep and Training</a></li>
  <li><a href="#fn-helpers" id="toc-fn-helpers" class="nav-link" data-scroll-target="#fn-helpers"><span class="header-section-number">7</span> FN-helpers</a></li>
  <li><a href="#create-glr-table" id="toc-create-glr-table" class="nav-link" data-scroll-target="#create-glr-table"><span class="header-section-number">8</span> Create GLR Table</a></li>
  <li><a href="#traintest-metrics" id="toc-traintest-metrics" class="nav-link" data-scroll-target="#traintest-metrics"><span class="header-section-number">9</span> Train/Test Metrics</a></li>
  <li><a href="#glr-summary" id="toc-glr-summary" class="nav-link" data-scroll-target="#glr-summary"><span class="header-section-number">10</span> GLR Summary</a></li>
  <li><a href="#polynomial-regression-prep" id="toc-polynomial-regression-prep" class="nav-link" data-scroll-target="#polynomial-regression-prep"><span class="header-section-number">11</span> Polynomial Regression Prep</a></li>
  <li><a href="#polynomial-coefficient-table" id="toc-polynomial-coefficient-table" class="nav-link" data-scroll-target="#polynomial-coefficient-table"><span class="header-section-number">12</span> Polynomial Coefficient Table</a></li>
  <li><a href="#polynomial-metrics" id="toc-polynomial-metrics" class="nav-link" data-scroll-target="#polynomial-metrics"><span class="header-section-number">13</span> Polynomial Metrics</a></li>
  <li><a href="#random-forest-regressor" id="toc-random-forest-regressor" class="nav-link" data-scroll-target="#random-forest-regressor"><span class="header-section-number">14</span> Random Forest Regressor</a></li>
  <li><a href="#feature-importance-plot" id="toc-feature-importance-plot" class="nav-link" data-scroll-target="#feature-importance-plot"><span class="header-section-number">15</span> Feature Importance Plot</a></li>
  <li><a href="#glr-polynomial-and-random-forest-comparison-prep" id="toc-glr-polynomial-and-random-forest-comparison-prep" class="nav-link" data-scroll-target="#glr-polynomial-and-random-forest-comparison-prep"><span class="header-section-number">16</span> GLR, Polynomial, and Random Forest Comparison Prep</a></li>
  <li><a href="#train-polynomial-glr" id="toc-train-polynomial-glr" class="nav-link" data-scroll-target="#train-polynomial-glr"><span class="header-section-number">17</span> Train Polynomial GLR</a></li>
  <li><a href="#compare-glr-vs-polynomial-vs-rf" id="toc-compare-glr-vs-polynomial-vs-rf" class="nav-link" data-scroll-target="#compare-glr-vs-polynomial-vs-rf"><span class="header-section-number">18</span> Compare GLR vs Polynomial vs RF</a></li>
  <li><a href="#glr-polynomial-and-random-forest-comparison-plot" id="toc-glr-polynomial-and-random-forest-comparison-plot" class="nav-link" data-scroll-target="#glr-polynomial-and-random-forest-comparison-plot"><span class="header-section-number">19</span> GLR, Polynomial, and Random Forest Comparison Plot</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Assignment 04</h1>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Makenzie Howard </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Boston University
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 6, 2025</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">October 7, 2025</p>
    </div>
  </div>
    
  </div>
  


</header>


<section id="load-the-dataset" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Load the dataset</h1>
<div id="6309022a" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#echo: true</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">#eval: true</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> SparkSession</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.io <span class="im">as</span> pio</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>pio.renderers.default <span class="op">=</span> <span class="st">"notebook+notebook_connected+vscode"</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize Spark Session</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>spark <span class="op">=</span> SparkSession.builder.appName(<span class="st">"LightcastData"</span>).getOrCreate()</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Load Data</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> spark.read.option(<span class="st">"header"</span>, <span class="st">"true"</span>).option(<span class="st">"inferSchema"</span>, <span class="st">"true"</span>).option(<span class="st">"multiLine"</span>,<span class="st">"true"</span>).option(<span class="st">"escape"</span>, <span class="st">"</span><span class="ch">\"</span><span class="st">"</span>).csv(<span class="st">"./data/lightcast_job_postings.csv"</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Show Schema and Sample Data</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"---This is Diagnostic check, No need to print it in the final doc---"</span>)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co"># df.printSchema() # comment this line when rendering the submission</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>df.show(<span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 211:&gt;                                                        (0 + 1) / 1]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>---This is Diagnostic check, No need to print it in the final doc---
+--------------------+-----------------+----------------------+----------+--------+---------+--------+--------------------+--------------------+--------------------+-----------+-------------------+--------------------+--------------------+---------------+----------------+--------+--------------------+-----------+-------------------+----------------+---------------------+-------------+-------------------+-------------+------------------+---------------+--------------------+--------------------+--------------------+-------------+------+-----------+----------------+-------------------+---------+-----------+--------------------+--------------------+-------------+------+--------------+-----+--------------------+-----+----------+---------------+--------------------+---------------+--------------------+------------+--------------------+------------+--------------------+------+--------------------+------+--------------------+------+--------------------+------+--------------------+------+--------------------+------------------+-------------------+--------------------+--------------------+--------------------+--------------------+-----------------------+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+----------+--------------------+----------+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+----------+--------------------+----------+--------------------+----------+---------------+----------+---------------+---------------+--------------------+--------------+--------------------+--------------------------+-------------------------------+--------------------+-------------------------+-----------------------------+----------------------------------+-----------------+----------------------+-----------------------+----------------------------+------------------+-----------------------+-------+--------------------+-------+--------------------+-------+---------------+-------+---------------+-----------------+----------------------+------------+--------------------+------------+--------------------+------------+--------------------+------------+--------------------+------------+--------------------+
|                  ID|LAST_UPDATED_DATE|LAST_UPDATED_TIMESTAMP|DUPLICATES|  POSTED|  EXPIRED|DURATION|        SOURCE_TYPES|             SOURCES|                 URL|ACTIVE_URLS|ACTIVE_SOURCES_INFO|           TITLE_RAW|                BODY|MODELED_EXPIRED|MODELED_DURATION| COMPANY|        COMPANY_NAME|COMPANY_RAW|COMPANY_IS_STAFFING|EDUCATION_LEVELS|EDUCATION_LEVELS_NAME|MIN_EDULEVELS| MIN_EDULEVELS_NAME|MAX_EDULEVELS|MAX_EDULEVELS_NAME|EMPLOYMENT_TYPE|EMPLOYMENT_TYPE_NAME|MIN_YEARS_EXPERIENCE|MAX_YEARS_EXPERIENCE|IS_INTERNSHIP|SALARY|REMOTE_TYPE|REMOTE_TYPE_NAME|ORIGINAL_PAY_PERIOD|SALARY_TO|SALARY_FROM|            LOCATION|                CITY|    CITY_NAME|COUNTY|   COUNTY_NAME|  MSA|            MSA_NAME|STATE|STATE_NAME|COUNTY_OUTGOING|COUNTY_NAME_OUTGOING|COUNTY_INCOMING|COUNTY_NAME_INCOMING|MSA_OUTGOING|   MSA_NAME_OUTGOING|MSA_INCOMING|   MSA_NAME_INCOMING|NAICS2|         NAICS2_NAME|NAICS3|         NAICS3_NAME|NAICS4|         NAICS4_NAME|NAICS5|         NAICS5_NAME|NAICS6|         NAICS6_NAME|             TITLE|         TITLE_NAME|         TITLE_CLEAN|              SKILLS|         SKILLS_NAME|  SPECIALIZED_SKILLS|SPECIALIZED_SKILLS_NAME|      CERTIFICATIONS| CERTIFICATIONS_NAME|       COMMON_SKILLS|  COMMON_SKILLS_NAME|     SOFTWARE_SKILLS|SOFTWARE_SKILLS_NAME|      ONET|           ONET_NAME| ONET_2019|      ONET_2019_NAME|                CIP6|           CIP6_NAME|                CIP4|           CIP4_NAME|                CIP2|           CIP2_NAME|SOC_2021_2|     SOC_2021_2_NAME|SOC_2021_3|     SOC_2021_3_NAME|SOC_2021_4|SOC_2021_4_NAME|SOC_2021_5|SOC_2021_5_NAME|LOT_CAREER_AREA|LOT_CAREER_AREA_NAME|LOT_OCCUPATION| LOT_OCCUPATION_NAME|LOT_SPECIALIZED_OCCUPATION|LOT_SPECIALIZED_OCCUPATION_NAME|LOT_OCCUPATION_GROUP|LOT_OCCUPATION_GROUP_NAME|LOT_V6_SPECIALIZED_OCCUPATION|LOT_V6_SPECIALIZED_OCCUPATION_NAME|LOT_V6_OCCUPATION|LOT_V6_OCCUPATION_NAME|LOT_V6_OCCUPATION_GROUP|LOT_V6_OCCUPATION_GROUP_NAME|LOT_V6_CAREER_AREA|LOT_V6_CAREER_AREA_NAME|  SOC_2|          SOC_2_NAME|  SOC_3|          SOC_3_NAME|  SOC_4|     SOC_4_NAME|  SOC_5|     SOC_5_NAME|LIGHTCAST_SECTORS|LIGHTCAST_SECTORS_NAME|NAICS_2022_2|   NAICS_2022_2_NAME|NAICS_2022_3|   NAICS_2022_3_NAME|NAICS_2022_4|   NAICS_2022_4_NAME|NAICS_2022_5|   NAICS_2022_5_NAME|NAICS_2022_6|   NAICS_2022_6_NAME|
+--------------------+-----------------+----------------------+----------+--------+---------+--------+--------------------+--------------------+--------------------+-----------+-------------------+--------------------+--------------------+---------------+----------------+--------+--------------------+-----------+-------------------+----------------+---------------------+-------------+-------------------+-------------+------------------+---------------+--------------------+--------------------+--------------------+-------------+------+-----------+----------------+-------------------+---------+-----------+--------------------+--------------------+-------------+------+--------------+-----+--------------------+-----+----------+---------------+--------------------+---------------+--------------------+------------+--------------------+------------+--------------------+------+--------------------+------+--------------------+------+--------------------+------+--------------------+------+--------------------+------------------+-------------------+--------------------+--------------------+--------------------+--------------------+-----------------------+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+----------+--------------------+----------+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+----------+--------------------+----------+--------------------+----------+---------------+----------+---------------+---------------+--------------------+--------------+--------------------+--------------------------+-------------------------------+--------------------+-------------------------+-----------------------------+----------------------------------+-----------------+----------------------+-----------------------+----------------------------+------------------+-----------------------+-------+--------------------+-------+--------------------+-------+---------------+-------+---------------+-----------------+----------------------+------------+--------------------+------------+--------------------+------------+--------------------+------------+--------------------+------------+--------------------+
|1f57d95acf4dc67ed...|         9/6/2024|  2024-09-06 20:32:...|         0|6/2/2024| 6/8/2024|       6|   [\n  "Company"\n]|[\n  "brassring.c...|[\n  "https://sjo...|         []|               NULL|Enterprise Analys...|31-May-2024\n\nEn...|       6/8/2024|               6|  894731|          Murphy USA| Murphy USA|              false|       [\n  2\n]| [\n  "Bachelor's ...|            2|  Bachelor's degree|         NULL|              NULL|              1|Full-time (&gt; 32 h...|                   2|                   2|        false|  NULL|          0|          [None]|               NULL|     NULL|       NULL|{\n  "lat": 33.20...|RWwgRG9yYWRvLCBBUg==|El Dorado, AR|  5139|     Union, AR|20980|       El Dorado, AR|    5|  Arkansas|           5139|           Union, AR|           5139|           Union, AR|       20980|       El Dorado, AR|       20980|       El Dorado, AR|    44|        Retail Trade|   441|Motor Vehicle and...|  4413|Automotive Parts,...| 44133|Automotive Parts ...|441330|Automotive Parts ...|ET29C073C03D1F86B4|Enterprise Analysts|enterprise analys...|[\n  "KS126DB6T06...|[\n  "Merchandisi...|[\n  "KS126DB6T06...|   [\n  "Merchandisi...|                  []|                  []|[\n  "KS126706DPF...|[\n  "Mathematics...|[\n  "KS440W865GC...|[\n  "SQL (Progra...|15-2051.01|Business Intellig...|15-2051.01|Business Intellig...|[\n  "45.0601",\n...|[\n  "Economics, ...|[\n  "45.06",\n  ...|[\n  "Economics",...|[\n  "45",\n  "27...|[\n  "Social Scie...|   15-0000|Computer and Math...|   15-2000|Mathematical Scie...|   15-2050|Data Scientists|   15-2051|Data Scientists|             23|Information Techn...|        231010|Business Intellig...|                  23101011|           General ERP Analy...|                2310|     Business Intellig...|                     23101011|              General ERP Analy...|           231010|  Business Intellig...|                   2310|        Business Intellig...|                23|   Information Techn...|15-0000|Computer and Math...|15-2000|Mathematical Scie...|15-2050|Data Scientists|15-2051|Data Scientists|        [\n  7\n]|  [\n  "Artificial ...|          44|        Retail Trade|         441|Motor Vehicle and...|        4413|Automotive Parts,...|       44133|Automotive Parts ...|      441330|Automotive Parts ...|
|0cb072af26757b6c4...|         8/2/2024|  2024-08-02 17:08:...|         0|6/2/2024| 8/1/2024|    NULL| [\n  "Job Board"\n]| [\n  "maine.gov"\n]|[\n  "https://job...|         []|               NULL|Oracle Consultant...|Oracle Consultant...|       8/1/2024|            NULL|  133098|Smx Corporation L...|        SMX|               true|      [\n  99\n]| [\n  "No Educatio...|           99|No Education Listed|         NULL|              NULL|              1|Full-time (&gt; 32 h...|                   3|                   3|        false|  NULL|          1|          Remote|               NULL|     NULL|       NULL|{\n  "lat": 44.31...|    QXVndXN0YSwgTUU=|  Augusta, ME| 23011|  Kennebec, ME|12300|Augusta-Watervill...|   23|     Maine|          23011|        Kennebec, ME|          23011|        Kennebec, ME|       12300|Augusta-Watervill...|       12300|Augusta-Watervill...|    56|Administrative an...|   561|Administrative an...|  5613| Employment Services| 56132|Temporary Help Se...|561320|Temporary Help Se...|ET21DDA63780A7DC09| Oracle Consultants|oracle consultant...|[\n  "KS122626T55...|[\n  "Procurement...|[\n  "KS122626T55...|   [\n  "Procurement...|                  []|                  []|                  []|                  []|[\n  "BGSBF3F508F...|[\n  "Oracle Busi...|15-2051.01|Business Intellig...|15-2051.01|Business Intellig...|                  []|                  []|                  []|                  []|                  []|                  []|   15-0000|Computer and Math...|   15-2000|Mathematical Scie...|   15-2050|Data Scientists|   15-2051|Data Scientists|             23|Information Techn...|        231010|Business Intellig...|                  23101012|           Oracle Consultant...|                2310|     Business Intellig...|                     23101012|              Oracle Consultant...|           231010|  Business Intellig...|                   2310|        Business Intellig...|                23|   Information Techn...|15-0000|Computer and Math...|15-2000|Mathematical Scie...|15-2050|Data Scientists|15-2051|Data Scientists|             NULL|                  NULL|          56|Administrative an...|         561|Administrative an...|        5613| Employment Services|       56132|Temporary Help Se...|      561320|Temporary Help Se...|
|85318b12b3331fa49...|         9/6/2024|  2024-09-06 20:32:...|         1|6/2/2024| 7/7/2024|      35| [\n  "Job Board"\n]|[\n  "dejobs.org"\n]|[\n  "https://dej...|         []|               NULL|        Data Analyst|Taking care of pe...|      6/10/2024|               8|39063746|            Sedgwick|   Sedgwick|              false|       [\n  2\n]| [\n  "Bachelor's ...|            2|  Bachelor's degree|         NULL|              NULL|              1|Full-time (&gt; 32 h...|                   5|                NULL|        false|  NULL|          0|          [None]|               NULL|     NULL|       NULL|{\n  "lat": 32.77...|    RGFsbGFzLCBUWA==|   Dallas, TX| 48113|    Dallas, TX|19100|Dallas-Fort Worth...|   48|     Texas|          48113|          Dallas, TX|          48113|          Dallas, TX|       19100|Dallas-Fort Worth...|       19100|Dallas-Fort Worth...|    52|Finance and Insur...|   524|Insurance Carrier...|  5242|Agencies, Brokera...| 52429|Other Insurance R...|524291|    Claims Adjusting|ET3037E0C947A02404|      Data Analysts|        data analyst|[\n  "KS1218W78FG...|[\n  "Management"...|[\n  "ESF3939CE1F...|   [\n  "Exception R...|[\n  "KS683TN76T7...|[\n  "Security Cl...|[\n  "KS1218W78FG...|[\n  "Management"...|[\n  "KS126HY6YLT...|[\n  "Microsoft O...|15-2051.01|Business Intellig...|15-2051.01|Business Intellig...|                  []|                  []|                  []|                  []|                  []|                  []|   15-0000|Computer and Math...|   15-2000|Mathematical Scie...|   15-2050|Data Scientists|   15-2051|Data Scientists|             23|Information Techn...|        231113|Data / Data Minin...|                  23111310|                   Data Analyst|                2311|     Data Analysis and...|                     23111310|                      Data Analyst|           231113|  Data / Data Minin...|                   2311|        Data Analysis and...|                23|   Information Techn...|15-0000|Computer and Math...|15-2000|Mathematical Scie...|15-2050|Data Scientists|15-2051|Data Scientists|             NULL|                  NULL|          52|Finance and Insur...|         524|Insurance Carrier...|        5242|Agencies, Brokera...|       52429|Other Insurance R...|      524291|    Claims Adjusting|
|1b5c3941e54a1889e...|         9/6/2024|  2024-09-06 20:32:...|         1|6/2/2024|7/20/2024|      48| [\n  "Job Board"\n]|[\n  "disabledper...|[\n  "https://www...|         []|               NULL|Sr. Lead Data Mgm...|About this role:\...|      6/12/2024|              10|37615159|         Wells Fargo|Wells Fargo|              false|      [\n  99\n]| [\n  "No Educatio...|           99|No Education Listed|         NULL|              NULL|              1|Full-time (&gt; 32 h...|                   3|                NULL|        false|  NULL|          0|          [None]|               NULL|     NULL|       NULL|{\n  "lat": 33.44...|    UGhvZW5peCwgQVo=|  Phoenix, AZ|  4013|  Maricopa, AZ|38060|Phoenix-Mesa-Chan...|    4|   Arizona|           4013|        Maricopa, AZ|           4013|        Maricopa, AZ|       38060|Phoenix-Mesa-Chan...|       38060|Phoenix-Mesa-Chan...|    52|Finance and Insur...|   522|Credit Intermedia...|  5221|Depository Credit...| 52211|  Commercial Banking|522110|  Commercial Banking|ET2114E0404BA30075|Management Analysts|sr lead data mgmt...|[\n  "KS123QX62QY...|[\n  "Exit Strate...|[\n  "KS123QX62QY...|   [\n  "Exit Strate...|                  []|                  []|[\n  "KS7G6NP6R6L...|[\n  "Reliability...|[\n  "KS4409D76NW...|[\n  "SAS (Softwa...|15-2051.01|Business Intellig...|15-2051.01|Business Intellig...|                  []|                  []|                  []|                  []|                  []|                  []|   15-0000|Computer and Math...|   15-2000|Mathematical Scie...|   15-2050|Data Scientists|   15-2051|Data Scientists|             23|Information Techn...|        231113|Data / Data Minin...|                  23111310|                   Data Analyst|                2311|     Data Analysis and...|                     23111310|                      Data Analyst|           231113|  Data / Data Minin...|                   2311|        Data Analysis and...|                23|   Information Techn...|15-0000|Computer and Math...|15-2000|Mathematical Scie...|15-2050|Data Scientists|15-2051|Data Scientists|        [\n  6\n]|  [\n  "Data Privac...|          52|Finance and Insur...|         522|Credit Intermedia...|        5221|Depository Credit...|       52211|  Commercial Banking|      522110|  Commercial Banking|
|cb5ca25f02bdf25c1...|        6/19/2024|   2024-06-19 07:00:00|         0|6/2/2024|6/17/2024|      15|[\n  "FreeJobBoar...|[\n  "craigslist....|[\n  "https://mod...|         []|               NULL|Comisiones de $10...|Comisiones de $10...|      6/17/2024|              15|       0|        Unclassified|      LH/GM|              false|      [\n  99\n]| [\n  "No Educatio...|           99|No Education Listed|         NULL|              NULL|              3|Part-time / full-...|                NULL|                NULL|        false| 92500|          0|          [None]|               year|   150000|      35000|{\n  "lat": 37.63...|    TW9kZXN0bywgQ0E=|  Modesto, CA|  6099|Stanislaus, CA|33700|         Modesto, CA|    6|California|           6099|      Stanislaus, CA|           6099|      Stanislaus, CA|       33700|         Modesto, CA|       33700|         Modesto, CA|    99|Unclassified Indu...|   999|Unclassified Indu...|  9999|Unclassified Indu...| 99999|Unclassified Indu...|999999|Unclassified Indu...|ET0000000000000000|       Unclassified|comisiones de por...|                  []|                  []|                  []|                     []|                  []|                  []|                  []|                  []|                  []|                  []|15-2051.01|Business Intellig...|15-2051.01|Business Intellig...|                  []|                  []|                  []|                  []|                  []|                  []|   15-0000|Computer and Math...|   15-2000|Mathematical Scie...|   15-2050|Data Scientists|   15-2051|Data Scientists|             23|Information Techn...|        231010|Business Intellig...|                  23101012|           Oracle Consultant...|                2310|     Business Intellig...|                     23101012|              Oracle Consultant...|           231010|  Business Intellig...|                   2310|        Business Intellig...|                23|   Information Techn...|15-0000|Computer and Math...|15-2000|Mathematical Scie...|15-2050|Data Scientists|15-2051|Data Scientists|             NULL|                  NULL|          99|Unclassified Indu...|         999|Unclassified Indu...|        9999|Unclassified Indu...|       99999|Unclassified Indu...|      999999|Unclassified Indu...|
+--------------------+-----------------+----------------------+----------+--------+---------+--------+--------------------+--------------------+--------------------+-----------+-------------------+--------------------+--------------------+---------------+----------------+--------+--------------------+-----------+-------------------+----------------+---------------------+-------------+-------------------+-------------+------------------+---------------+--------------------+--------------------+--------------------+-------------+------+-----------+----------------+-------------------+---------+-----------+--------------------+--------------------+-------------+------+--------------+-----+--------------------+-----+----------+---------------+--------------------+---------------+--------------------+------------+--------------------+------------+--------------------+------+--------------------+------+--------------------+------+--------------------+------+--------------------+------+--------------------+------------------+-------------------+--------------------+--------------------+--------------------+--------------------+-----------------------+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+----------+--------------------+----------+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+----------+--------------------+----------+--------------------+----------+---------------+----------+---------------+---------------+--------------------+--------------+--------------------+--------------------------+-------------------------------+--------------------+-------------------------+-----------------------------+----------------------------------+-----------------+----------------------+-----------------------+----------------------------+------------------+-----------------------+-------+--------------------+-------+--------------------+-------+---------------+-------+---------------+-----------------+----------------------+------------+--------------------+------------+--------------------+------------+--------------------+------------+--------------------+------------+--------------------+
only showing top 5 rows
</code></pre>
</div>
</div>
</section>
<section id="pick-eda-columns-and-preview" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Pick EDA Columns and Preview</h1>
<div id="99391562" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>eda_cols <span class="op">=</span> [</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SALARY"</span>,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MIN_YEARS_EXPERIENCE"</span>,<span class="st">"MAX_YEARS_EXPERIENCE"</span>,<span class="st">"DURATION"</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"COMPANY_IS_STAFFING"</span>,<span class="st">"IS_INTERNSHIP"</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"STATE_NAME"</span>,<span class="st">"REMOTE_TYPE_NAME"</span>,<span class="st">"EMPLOYMENT_TYPE_NAME"</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MIN_EDULEVELS_NAME"</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>existing <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> eda_cols <span class="cf">if</span> c <span class="kw">in</span> df.columns]</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>missing  <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> eda_cols <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> df.columns]</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> missing:</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Missing (skipped):"</span>, missing)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>df_eda <span class="op">=</span> df.select(<span class="op">*</span>existing)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>df_eda.show(<span class="dv">5</span>, truncate<span class="op">=</span><span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>+------+--------------------+--------------------+--------+-------------------+-------------+----------+----------------+----------------------+-------------------+
|SALARY|MIN_YEARS_EXPERIENCE|MAX_YEARS_EXPERIENCE|DURATION|COMPANY_IS_STAFFING|IS_INTERNSHIP|STATE_NAME|REMOTE_TYPE_NAME|EMPLOYMENT_TYPE_NAME  |MIN_EDULEVELS_NAME |
+------+--------------------+--------------------+--------+-------------------+-------------+----------+----------------+----------------------+-------------------+
|NULL  |2                   |2                   |6       |false              |false        |Arkansas  |[None]          |Full-time (&gt; 32 hours)|Bachelor's degree  |
|NULL  |3                   |3                   |NULL    |true               |false        |Maine     |Remote          |Full-time (&gt; 32 hours)|No Education Listed|
|NULL  |5                   |NULL                |35      |false              |false        |Texas     |[None]          |Full-time (&gt; 32 hours)|Bachelor's degree  |
|NULL  |3                   |NULL                |48      |false              |false        |Arizona   |[None]          |Full-time (&gt; 32 hours)|No Education Listed|
|92500 |NULL                |NULL                |15      |false              |false        |California|[None]          |Part-time / full-time |No Education Listed|
+------+--------------------+--------------------+--------+-------------------+-------------+----------+----------------+----------------------+-------------------+
only showing top 5 rows
</code></pre>
</div>
</div>
</section>
<section id="clean-categoricals-and-imputations" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Clean Categoricals and imputations</h1>
<div id="7c223560" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> col, when, trim, lower, regexp_replace, coalesce, lit</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># REMOTE_TYPE_NAME normalize</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>df_eda <span class="op">=</span> (df_eda</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    .withColumn(<span class="st">"REMOTE_TYPE_NAME"</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        when(trim(col(<span class="st">"REMOTE_TYPE_NAME"</span>)) <span class="op">==</span> <span class="st">"Remote"</span>,<span class="st">"Remote"</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        .when(trim(col(<span class="st">"REMOTE_TYPE_NAME"</span>)) <span class="op">==</span> <span class="st">"[None]"</span>,<span class="st">"Undefined"</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        .when(trim(col(<span class="st">"REMOTE_TYPE_NAME"</span>)) <span class="op">==</span> <span class="st">"Not Remote"</span>,<span class="st">"On Premise"</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        .when(trim(col(<span class="st">"REMOTE_TYPE_NAME"</span>)) <span class="op">==</span> <span class="st">"Hybrid Remote"</span>,<span class="st">"Hybrid"</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        .when(col(<span class="st">"REMOTE_TYPE_NAME"</span>).isNull(),<span class="st">"On Premise"</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        .otherwise(col(<span class="st">"REMOTE_TYPE_NAME"</span>))</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co"># EMPLOYMENT_TYPE_NAME normalize</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>emp_norm <span class="op">=</span> regexp_replace(lower(trim(col(<span class="st">"EMPLOYMENT_TYPE_NAME"</span>))), <span class="vs">r"</span><span class="dv">\s</span><span class="op">+</span><span class="vs">"</span>, <span class="st">" "</span>)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>df_eda <span class="op">=</span> (df_eda</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    .withColumn(<span class="st">"EMPLOYMENT_TYPE_NAME"</span>,</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        when(col(<span class="st">"EMPLOYMENT_TYPE_NAME"</span>).isNull(),<span class="st">"Fulltime"</span>)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        .when(emp_norm.isin(<span class="st">"part-time / full-time"</span>,<span class="st">"part time / full time"</span>,<span class="st">"part-time/full-time"</span>),<span class="st">"Flexible"</span>)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        .when(emp_norm.rlike(<span class="vs">r"part</span><span class="pp">[- ]</span><span class="op">?</span><span class="vs">time</span><span class="dv">\s</span><span class="op">*</span><span class="ch">\(</span><span class="kw">(</span><span class="vs">&lt;=</span><span class="cf">|</span><span class="vs">≤</span><span class="kw">)</span><span class="dv">\s</span><span class="op">*</span><span class="vs">32</span><span class="dv">\s</span><span class="op">*</span><span class="vs">hours</span><span class="ch">\)</span><span class="vs">"</span>),<span class="st">"Parttime"</span>)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        .when(emp_norm.rlike(<span class="vs">r"full</span><span class="pp">[- ]</span><span class="op">?</span><span class="vs">time</span><span class="dv">\s</span><span class="op">*</span><span class="ch">\(</span><span class="vs">&gt;</span><span class="dv">\s</span><span class="op">*</span><span class="vs">32</span><span class="dv">\s</span><span class="op">*</span><span class="vs">hours</span><span class="ch">\)</span><span class="vs">"</span>),<span class="st">"Fulltime"</span>)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>        .otherwise(col(<span class="st">"EMPLOYMENT_TYPE_NAME"</span>))</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Booleans → fill nulls</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"COMPANY_IS_STAFFING"</span> <span class="kw">in</span> df_eda.columns:</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    df_eda <span class="op">=</span> df_eda.withColumn(<span class="st">"COMPANY_IS_STAFFING"</span>, coalesce(col(<span class="st">"COMPANY_IS_STAFFING"</span>), lit(<span class="va">False</span>)).cast(<span class="st">"double"</span>))</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"IS_INTERNSHIP"</span> <span class="kw">in</span> df_eda.columns:</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    df_eda <span class="op">=</span> df_eda.withColumn(<span class="st">"IS_INTERNSHIP"</span>, coalesce(col(<span class="st">"IS_INTERNSHIP"</span>), lit(<span class="va">False</span>)).cast(<span class="st">"double"</span>))</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="co"># DURATION → numeric + median fill</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"DURATION"</span> <span class="kw">in</span> df_eda.columns:</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    df_eda <span class="op">=</span> df_eda.withColumn(<span class="st">"DURATION"</span>, col(<span class="st">"DURATION"</span>).cast(<span class="st">"double"</span>))</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    med <span class="op">=</span> df_eda.where(col(<span class="st">"DURATION"</span>).isNotNull()).approxQuantile(<span class="st">"DURATION"</span>,[<span class="fl">0.5</span>],<span class="fl">0.01</span>)[<span class="dv">0</span>]</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    df_eda <span class="op">=</span> df_eda.withColumn(<span class="st">"DURATION"</span>, coalesce(col(<span class="st">"DURATION"</span>), lit(<span class="bu">float</span>(med))).cast(<span class="st">"double"</span>))</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Imputed DURATION median:"</span>, med)</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>df_eda.show(<span class="dv">5</span>, truncate<span class="op">=</span><span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 214:&gt;                                                        (0 + 1) / 1]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Imputed DURATION median: 18.0
+------+--------------------+--------------------+--------+-------------------+-------------+----------+----------------+--------------------+-------------------+
|SALARY|MIN_YEARS_EXPERIENCE|MAX_YEARS_EXPERIENCE|DURATION|COMPANY_IS_STAFFING|IS_INTERNSHIP|STATE_NAME|REMOTE_TYPE_NAME|EMPLOYMENT_TYPE_NAME|MIN_EDULEVELS_NAME |
+------+--------------------+--------------------+--------+-------------------+-------------+----------+----------------+--------------------+-------------------+
|NULL  |2                   |2                   |6.0     |0.0                |0.0          |Arkansas  |Undefined       |Fulltime            |Bachelor's degree  |
|NULL  |3                   |3                   |18.0    |1.0                |0.0          |Maine     |Remote          |Fulltime            |No Education Listed|
|NULL  |5                   |NULL                |35.0    |0.0                |0.0          |Texas     |Undefined       |Fulltime            |Bachelor's degree  |
|NULL  |3                   |NULL                |48.0    |0.0                |0.0          |Arizona   |Undefined       |Fulltime            |No Education Listed|
|92500 |NULL                |NULL                |15.0    |0.0                |0.0          |California|Undefined       |Flexible            |No Education Listed|
+------+--------------------+--------------------+--------+-------------------+-------------+----------+----------------+--------------------+-------------------+
only showing top 5 rows
</code></pre>
</div>
</div>
</section>
<section id="vectorize-state_name-and-min_edulevels_name" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Vectorize STATE_NAME and MIN_EDULEVELS_NAME</h1>
<div id="1da93e19" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> decimal <span class="im">import</span> Decimal</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyspark.sql.functions <span class="im">as</span> F</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> col, <span class="bu">pow</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.types <span class="im">import</span> DoubleType</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml <span class="im">import</span> Pipeline</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.feature <span class="im">import</span> StringIndexer, OneHotEncoder, VectorAssembler</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>LABEL_COL  <span class="op">=</span> <span class="st">"SALARY"</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>MINEXP_COL <span class="op">=</span> <span class="st">"MIN_YEARS_EXPERIENCE"</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _parse_salary_any(x):</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x <span class="kw">is</span> <span class="va">None</span>: <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(x,(<span class="bu">int</span>,<span class="bu">float</span>,Decimal)):</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>        v <span class="op">=</span> <span class="bu">float</span>(x)<span class="op">;</span> <span class="cf">return</span> v <span class="cf">if</span> v <span class="op">==</span> v <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> <span class="bu">str</span>(x).strip().lower()</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> s: <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> s.replace(<span class="st">","</span>,<span class="st">" "</span>)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    tokens <span class="op">=</span> re.findall(<span class="vs">r'</span><span class="kw">(</span><span class="dv">\d</span><span class="op">+</span>(?:<span class="ch">\.</span><span class="dv">\d</span><span class="op">+</span>)<span class="op">?</span><span class="dv">\s</span><span class="op">*</span><span class="vs">k</span><span class="op">?</span><span class="kw">)</span><span class="vs">'</span>, s)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> to_num(tok):</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>        t <span class="op">=</span> tok.replace(<span class="st">" "</span>,<span class="st">""</span>)</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>        mult <span class="op">=</span> <span class="fl">1000.0</span> <span class="cf">if</span> t.endswith(<span class="st">"k"</span>) <span class="cf">else</span> <span class="fl">1.0</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> t.endswith(<span class="st">"k"</span>): t <span class="op">=</span> t[:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>: <span class="cf">return</span> <span class="bu">float</span>(t)<span class="op">*</span>mult</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>: <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    nums <span class="op">=</span> [n <span class="cf">for</span> n <span class="kw">in</span> (to_num(t) <span class="cf">for</span> t <span class="kw">in</span> tokens) <span class="cf">if</span> n <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>]</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> nums: <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">float</span>(<span class="bu">sum</span>(nums[:<span class="dv">2</span>])<span class="op">/</span><span class="fl">2.0</span>) <span class="cf">if</span> <span class="bu">len</span>(nums)<span class="op">&gt;=</span><span class="dv">2</span> <span class="cf">else</span> <span class="bu">float</span>(nums[<span class="dv">0</span>])</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>parse_salary_udf <span class="op">=</span> F.udf(_parse_salary_any, DoubleType())</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> (df_eda</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    .withColumn(LABEL_COL, parse_salary_udf(col(LABEL_COL)))</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    .withColumn(MINEXP_COL, col(MINEXP_COL).cast(<span class="st">"double"</span>))</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a><span class="co"># pick 3 continuous</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>preferred <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> [<span class="st">"DURATION"</span>,<span class="st">"MODELED_DURATION"</span>,<span class="st">"DUPLICATES"</span>,<span class="st">"MAX_YEARS_EXPERIENCE"</span>] <span class="cf">if</span> c <span class="kw">in</span> base.columns]</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>continuous_cols <span class="op">=</span> []</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> preferred:</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>    base <span class="op">=</span> base.withColumn(c, col(c).cast(<span class="st">"double"</span>))</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    med_list <span class="op">=</span> base.where(col(c).isNotNull()).approxQuantile(c,[<span class="fl">0.5</span>],<span class="fl">0.01</span>)</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>    med <span class="op">=</span> <span class="bu">float</span>(med_list[<span class="dv">0</span>]) <span class="cf">if</span> med_list <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>    base <span class="op">=</span> base.withColumn(c, F.coalesce(col(c), F.lit(med)))</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>    continuous_cols.append(c)</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(continuous_cols)<span class="op">==</span><span class="dv">3</span>: <span class="cf">break</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(continuous_cols)<span class="op">&lt;</span><span class="dv">3</span> <span class="kw">and</span> <span class="st">"DURATION"</span> <span class="kw">in</span> base.columns:</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>    base <span class="op">=</span> base.withColumn(<span class="st">"DURATION_LOG1P"</span>, F.log1p(col(<span class="st">"DURATION"</span>)))</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>    continuous_cols.append(<span class="st">"DURATION_LOG1P"</span>)</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(continuous_cols)<span class="op">&lt;</span><span class="dv">3</span> <span class="kw">and</span> <span class="st">"DURATION"</span> <span class="kw">in</span> base.columns:</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>    base <span class="op">=</span> base.withColumn(<span class="st">"DURATION_SQRT"</span>, F.sqrt(col(<span class="st">"DURATION"</span>)))</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>    continuous_cols.append(<span class="st">"DURATION_SQRT"</span>)</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>continuous_cols <span class="op">=</span> continuous_cols[:<span class="dv">3</span>]</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>categorical_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> [<span class="st">"STATE_NAME"</span>,<span class="st">"MIN_EDULEVELS_NAME"</span>] <span class="cf">if</span> c <span class="kw">in</span> base.columns]</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a><span class="co"># drop rows missing the exact training columns</span></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>key_cols <span class="op">=</span> [LABEL_COL, MINEXP_COL] <span class="op">+</span> continuous_cols <span class="op">+</span> categorical_cols</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>df_feat <span class="op">=</span> base.dropna(subset<span class="op">=</span>key_cols)</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a><span class="co"># index + ohe + assemble</span></span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>indexers <span class="op">=</span> [StringIndexer(inputCol<span class="op">=</span>c, outputCol<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_idx"</span>, handleInvalid<span class="op">=</span><span class="st">"keep"</span>) <span class="cf">for</span> c <span class="kw">in</span> categorical_cols]</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>encoder  <span class="op">=</span> OneHotEncoder(</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>    inputCols<span class="op">=</span>[<span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_idx"</span> <span class="cf">for</span> c <span class="kw">in</span> categorical_cols],</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>    outputCols<span class="op">=</span>[<span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_vec"</span> <span class="cf">for</span> c <span class="kw">in</span> categorical_cols],</span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>    handleInvalid<span class="op">=</span><span class="st">"keep"</span>,</span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>    dropLast<span class="op">=</span><span class="va">True</span></span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>assembler_inputs <span class="op">=</span> [MINEXP_COL] <span class="op">+</span> continuous_cols <span class="op">+</span> [<span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_vec"</span> <span class="cf">for</span> c <span class="kw">in</span> categorical_cols]</span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>assembler <span class="op">=</span> VectorAssembler(inputCols<span class="op">=</span>assembler_inputs, outputCol<span class="op">=</span><span class="st">"features"</span>)</span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>vec_model <span class="op">=</span> Pipeline(stages<span class="op">=</span>indexers <span class="op">+</span> [encoder, assembler]).fit(df_feat)</span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>data_exact <span class="op">=</span> vec_model.transform(df_feat)</span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a><span class="co"># polynomial vector</span></span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>data_exact <span class="op">=</span> data_exact.withColumn(<span class="ss">f"</span><span class="sc">{</span>MINEXP_COL<span class="sc">}</span><span class="ss">_SQ"</span>, <span class="bu">pow</span>(col(MINEXP_COL), <span class="fl">2.0</span>))</span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>poly_asm <span class="op">=</span> VectorAssembler(inputCols<span class="op">=</span>[MINEXP_COL, <span class="ss">f"</span><span class="sc">{</span>MINEXP_COL<span class="sc">}</span><span class="ss">_SQ"</span>], outputCol<span class="op">=</span><span class="st">"features_poly"</span>)</span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>data_exact <span class="op">=</span> poly_asm.transform(data_exact)</span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Using features:"</span>)</span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  y:"</span>, LABEL_COL)</span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  must-have:"</span>, MINEXP_COL)</span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  continuous (3):"</span>, continuous_cols)</span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  categorical (2):"</span>, categorical_cols)</span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a>data_exact.select(LABEL_COL,<span class="st">"features"</span>,<span class="st">"features_poly"</span>).show(<span class="dv">5</span>, truncate<span class="op">=</span><span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 216:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 217:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 218:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 221:&gt;                                                        (0 + 1) / 1]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Using features:
  y: SALARY
  must-have: MIN_YEARS_EXPERIENCE
  continuous (3): ['DURATION', 'MAX_YEARS_EXPERIENCE', 'DURATION_LOG1P']
  categorical (2): ['STATE_NAME', 'MIN_EDULEVELS_NAME']</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 224:&gt;                                                        (0 + 1) / 1]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>+--------+---------------------------------------------------------------+-------------+
|SALARY  |features                                                       |features_poly|
+--------+---------------------------------------------------------------+-------------+
|92962.0 |(63,[0,1,2,3,6,56],[2.0,18.0,2.0,2.9444389791664403,1.0,1.0])  |[2.0,4.0]    |
|107645.0|(63,[0,1,2,3,4,59],[10.0,18.0,3.0,2.9444389791664403,1.0,1.0]) |[10.0,100.0] |
|192800.0|(63,[0,1,2,3,19,56],[6.0,55.0,3.0,4.02535169073515,1.0,1.0])   |[6.0,36.0]   |
|125900.0|(63,[0,1,2,3,17,58],[12.0,18.0,3.0,2.9444389791664403,1.0,1.0])|[12.0,144.0] |
|170000.0|(63,[0,1,2,3,4,57],[6.0,18.0,3.0,2.9444389791664403,1.0,1.0])  |[6.0,36.0]   |
+--------+---------------------------------------------------------------+-------------+
only showing top 5 rows
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                </code></pre>
</div>
</div>
</section>
<section id="traintest-split-with-seed" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Train/Test split with seed</h1>
<div id="8494667c" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> col</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> functions <span class="im">as</span> F</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>SEED <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>TRAIN_FRAC <span class="op">=</span> <span class="fl">0.80</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>src <span class="op">=</span> data_exact</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co"># safety</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> [<span class="st">"SALARY"</span>,<span class="st">"features"</span>]:</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> c <span class="kw">in</span> src.columns, <span class="ss">f"Missing column: </span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>train_df, test_df <span class="op">=</span> src.randomSplit([TRAIN_FRAC, <span class="dv">1</span><span class="op">-</span>TRAIN_FRAC], seed<span class="op">=</span>SEED)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>train_df.cache()<span class="op">;</span> test_df.cache()</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>n_total, n_train, n_test <span class="op">=</span> src.count(), train_df.count(), test_df.count()</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"=== Train/Test Split ==="</span>)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Seed: </span><span class="sc">{</span>SEED<span class="sc">}</span><span class="ss"> | Split: </span><span class="sc">{</span>TRAIN_FRAC<span class="sc">:.0%}</span><span class="ss">/</span><span class="sc">{</span><span class="dv">1</span><span class="op">-</span>TRAIN_FRAC<span class="sc">:.0%}</span><span class="ss">"</span>)</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total: </span><span class="sc">{</span>n_total<span class="sc">:,}</span><span class="ss"> | Train: </span><span class="sc">{</span>n_train<span class="sc">:,}</span><span class="ss"> | Test: </span><span class="sc">{</span>n_test<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, d <span class="kw">in</span> [(<span class="st">"TRAIN"</span>, train_df), (<span class="st">"TEST"</span>, test_df)]:</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">— </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> SALARY null check —"</span>)</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    d.select(F.<span class="bu">sum</span>(col(<span class="st">"SALARY"</span>).isNull().cast(<span class="st">"int"</span>)).alias(<span class="st">"salary_nulls"</span>)).show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 225:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 228:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 232:&gt;                                                        (0 + 1) / 1]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=== Train/Test Split ===
Seed: 42 | Split: 80%/20%
Total: 23,697 | Train: 18,966 | Test: 4,731

— TRAIN SALARY null check —
+------------+
|salary_nulls|
+------------+
|           0|
+------------+


— TEST SALARY null check —
+------------+
|salary_nulls|
+------------+
|           0|
+------------+
</code></pre>
</div>
</div>
</section>
<section id="linear-regression-model-ols-prep-and-training" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Linear Regression Model (OLS) Prep and Training</h1>
<div id="2fbb5826" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.regression <span class="im">import</span> GeneralizedLinearRegression</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>glr <span class="op">=</span> GeneralizedLinearRegression(</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    featuresCol<span class="op">=</span><span class="st">"features"</span>,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    labelCol<span class="op">=</span><span class="st">"SALARY"</span>,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    family<span class="op">=</span><span class="st">"gaussian"</span>,   </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    link<span class="op">=</span><span class="st">"identity"</span>,     </span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    maxIter<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    regParam<span class="op">=</span><span class="fl">0.3</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>glr_model <span class="op">=</span> glr.fit(train_df)   <span class="co"># requires train_df from the split chunk</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>summary <span class="op">=</span> glr_model.summary</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Fitted GLR. Intercept:"</span>, glr_model.intercept, <span class="st">"| Num features:"</span>, glr_model.numFeatures)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fitted GLR. Intercept: 88399.58369934643 | Num features: 63</code></pre>
</div>
</div>
</section>
<section id="fn-helpers" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> FN-helpers</h1>
<div id="581cfd64" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np, pandas <span class="im">as</span> pd</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_feature_names(vec_model, base_inputs, categorical_cols):</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Expand *_vec columns into readable one-hot names using the indexer labels</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co">    and OHE category sizes. Falls back to generic names if labels unavailable.</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    indexer_labels <span class="op">=</span> {}</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> st <span class="kw">in</span> <span class="bu">getattr</span>(vec_model, <span class="st">"stages"</span>, []):</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">hasattr</span>(st, <span class="st">"labels"</span>) <span class="kw">and</span> <span class="bu">hasattr</span>(st, <span class="st">"getOutputCol"</span>):</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>            out_col <span class="op">=</span> st.getOutputCol()</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> out_col.endswith(<span class="st">"_idx"</span>):</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>                indexer_labels[out_col[:<span class="op">-</span><span class="dv">4</span>]] <span class="op">=</span> <span class="bu">list</span>(st.labels)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    ohe_sizes <span class="op">=</span> {}</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> st <span class="kw">in</span> <span class="bu">getattr</span>(vec_model, <span class="st">"stages"</span>, []):</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">hasattr</span>(st, <span class="st">"categorySizes"</span>) <span class="kw">and</span> <span class="bu">hasattr</span>(st, <span class="st">"getOutputCols"</span>):</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> out, size <span class="kw">in</span> <span class="bu">zip</span>(st.getOutputCols(), st.categorySizes):</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>                ohe_sizes[out] <span class="op">=</span> <span class="bu">int</span>(size)</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    names <span class="op">=</span> []</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> base_inputs:</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> col.endswith(<span class="st">"_vec"</span>):</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>            base <span class="op">=</span> col[:<span class="op">-</span><span class="dv">4</span>]</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>            size <span class="op">=</span> ohe_sizes.get(col, <span class="bu">len</span>(indexer_labels.get(base, [])))</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>            onehot_len <span class="op">=</span> <span class="bu">max</span>((size <span class="kw">or</span> <span class="dv">1</span>) <span class="op">-</span> <span class="dv">1</span>, <span class="dv">0</span>)   <span class="co"># dropLast=True</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>            labels <span class="op">=</span> indexer_labels.get(base, [])</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> labels <span class="kw">and</span> <span class="bu">len</span>(labels) <span class="op">&gt;=</span> onehot_len:</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>                names.extend([<span class="ss">f"</span><span class="sc">{</span>base<span class="sc">}</span><span class="ss">=</span><span class="sc">{</span>lab<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> lab <span class="kw">in</span> labels[:onehot_len]])</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>                names.extend([<span class="ss">f"</span><span class="sc">{</span>base<span class="sc">}</span><span class="ss">__</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(onehot_len)])</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>            names.append(col)</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> names</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="create-glr-table" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Create GLR Table</h1>
<div id="a904051a" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Resolve feature names from your feature-engineering pipeline</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'assembler_inputs'</span> <span class="kw">in</span> <span class="bu">globals</span>():</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    base_inputs <span class="op">=</span> assembler_inputs</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="cf">elif</span> <span class="st">'assembler'</span> <span class="kw">in</span> <span class="bu">globals</span>():</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    base_inputs <span class="op">=</span> assembler.getInputCols()</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    base_inputs <span class="op">=</span> []</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'vec_model'</span> <span class="kw">in</span> <span class="bu">globals</span>() <span class="kw">and</span> base_inputs <span class="kw">and</span> <span class="st">'categorical_cols'</span> <span class="kw">in</span> <span class="bu">globals</span>():</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    feature_names <span class="op">=</span> build_feature_names(vec_model, base_inputs, categorical_cols)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    feature_names <span class="op">=</span> [<span class="ss">f"f</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(glr_model.numFeatures)]</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Pull coefficient stats from GLR summary</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>coefs <span class="op">=</span> np.array(glr_model.coefficients) <span class="cf">if</span> <span class="bu">hasattr</span>(glr_model.coefficients, <span class="st">"__array__"</span>) <span class="op">\</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> np.array(glr_model.coefficients.toArray())</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>se    <span class="op">=</span> np.array(summary.coefficientStandardErrors)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>tvals <span class="op">=</span> np.array(summary.tValues)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>pvals <span class="op">=</span> np.array(summary.pValues)</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="bu">min</span>(<span class="bu">len</span>(feature_names), <span class="bu">len</span>(coefs), <span class="bu">len</span>(se), <span class="bu">len</span>(tvals), <span class="bu">len</span>(pvals))</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>rows <span class="op">=</span> []</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    ci_low  <span class="op">=</span> coefs[i] <span class="op">-</span> <span class="fl">1.96</span><span class="op">*</span>se[i]</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    ci_high <span class="op">=</span> coefs[i] <span class="op">+</span> <span class="fl">1.96</span><span class="op">*</span>se[i]</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    rows.append([feature_names[i], coefs[i], se[i], tvals[i], pvals[i], ci_low, ci_high])</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>coef_df <span class="op">=</span> pd.DataFrame(</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    rows,</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>[<span class="st">"feature"</span>,<span class="st">"coef"</span>,<span class="st">"std_err"</span>,<span class="st">"t_value"</span>,<span class="st">"p_value"</span>,<span class="st">"ci_low_95"</span>,<span class="st">"ci_high_95"</span>]</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Intercept:"</span>, glr_model.intercept)</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== Coefficient table (first 40) ==="</span>)</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(coef_df.head(<span class="dv">40</span>).to_string(index<span class="op">=</span><span class="va">False</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Intercept: 88399.58369934643

=== Coefficient table (first 40) ===
                                           feature         coef      std_err   t_value  p_value      ci_low_95    ci_high_95
                              MIN_YEARS_EXPERIENCE  7451.887786    83.326049 89.430471 0.000000    7288.568730   7615.206842
                                          DURATION   136.756559    64.316557  2.126304 0.033491      10.696107    262.817011
                              MAX_YEARS_EXPERIENCE   494.046913   264.849720  1.865386 0.062143     -25.058539   1013.152364
                                    DURATION_LOG1P -4931.651642  1510.974164 -3.263889 0.001101   -7893.161003  -1970.142281
                             STATE_NAME=California  6901.863569 97632.983454  0.070692 0.943644 -184458.784000 198262.511138
                                  STATE_NAME=Texas -2926.383160 97634.172560 -0.029973 0.976089 -194289.361379 188436.595058
                               STATE_NAME=New York  3067.291631 97635.423793  0.031416 0.974938 -188298.139003 194432.722264
                                STATE_NAME=Florida -1895.881460 97636.929576 -0.019418 0.984508 -193264.263430 189472.500510
                               STATE_NAME=Virginia  -543.674003 97637.647535 -0.005568 0.995557 -191913.463172 190826.115165
                               STATE_NAME=Illinois  3095.482745 97638.229209  0.031704 0.974709 -188275.446504 194466.411994
                               STATE_NAME=Colorado -4237.846944 97640.364278 -0.043403 0.965381 -195612.960930 187137.267041
                         STATE_NAME=North Carolina -2327.193970 97640.765897 -0.023834 0.980985 -193703.095127 189048.707187
                             STATE_NAME=Washington  5543.590546 97640.601600  0.056775 0.954725 -185831.988590 196919.169682
                                   STATE_NAME=Ohio -1813.069078 97641.115988 -0.018569 0.985185 -193189.656414 189563.518258
                             STATE_NAME=New Jersey  3937.816625 97642.479514  0.040329 0.967831 -187441.443223 195317.076473
                                STATE_NAME=Georgia  3352.973366 97642.358715  0.034339 0.972607 -188026.049715 194731.996448
                          STATE_NAME=Massachusetts  1048.344077 97643.454810  0.010736 0.991434 -190332.827350 192429.515503
                                STATE_NAME=Arizona -3352.037565 97643.165087 -0.034329 0.972615 -194732.641135 188028.566006
                           STATE_NAME=Pennsylvania -1949.017495 97643.599794 -0.019961 0.984075 -193330.473091 189432.438100
                               STATE_NAME=Michigan   509.020278 97643.488198  0.005213 0.995841 -190872.216591 191890.257147
                                 STATE_NAME=Oregon -4947.075778 97645.281933 -0.050664 0.959594 -196331.828367 186437.676811
                              STATE_NAME=Minnesota -1643.363657 97645.575258 -0.016830 0.986573 -193028.691162 189741.963849
                               STATE_NAME=Maryland -5782.933454 97646.147709 -0.059223 0.952775 -197169.382963 185603.516056
                               STATE_NAME=Missouri   327.965056 97647.728501  0.003359 0.997320 -191061.582806 191717.512918
STATE_NAME=Washington, D.C. (District of Columbia) -2660.887055 97649.766810 -0.027249 0.978261 -194054.430002 188732.655893
                              STATE_NAME=Tennessee   198.056173 97650.636857  0.002028 0.998382 -191197.192066 191593.304412
                            STATE_NAME=Connecticut  8743.295702 97652.420135  0.089535 0.928658 -182655.447763 200142.039167
                                STATE_NAME=Indiana -1295.015483 97655.853944 -0.013261 0.989420 -192700.489214 190110.458247
                              STATE_NAME=Wisconsin  2176.694258 97655.739046  0.022289 0.982217 -189228.554272 193581.942788
                                 STATE_NAME=Kansas  1535.604935 97659.570118  0.015724 0.987455 -189877.152496 192948.362365
                               STATE_NAME=Arkansas  3621.571924 97660.575827  0.037083 0.970419 -187793.156698 195036.300545
                                   STATE_NAME=Iowa -1180.922567 97660.150159 -0.012092 0.990352 -192594.816879 190232.971744
                               STATE_NAME=Oklahoma -1583.471903 97660.398507 -0.016214 0.987064 -192997.852977 189830.909172
                                 STATE_NAME=Nevada -8089.465051 97664.807954 -0.082829 0.933988 -199512.488642 183333.558539
                                   STATE_NAME=Utah -7522.892847 97664.638834 -0.077028 0.938602 -198945.584961 183899.799267
                               STATE_NAME=Kentucky -5085.522257 97666.280963 -0.052070 0.958473 -196511.432944 186340.388430
                                STATE_NAME=Alabama -5968.821835 97668.044623 -0.061113 0.951270 -197398.189296 185460.545626
                         STATE_NAME=South Carolina   420.853796 97666.889043  0.004309 0.996562 -191006.248729 191847.956321
                                  STATE_NAME=Idaho  -378.787959 97666.905205 -0.003878 0.996906 -191805.922161 191048.346243
                           STATE_NAME=Rhode Island -1493.223237 97675.604119 -0.015288 0.987803 -192937.407311 189950.960837</code></pre>
</div>
</div>
</section>
<section id="traintest-metrics" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Train/Test Metrics</h1>
<div id="6595f0a5" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.evaluation <span class="im">import</span> RegressionEvaluator</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== TRAIN metrics (GLR) ==="</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"AIC:"</span>, summary.aic)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Deviance:"</span>, summary.deviance, <span class="st">"| Null Deviance:"</span>, summary.nullDeviance)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Dispersion:"</span>, summary.dispersion)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"DoF Residual:"</span>, summary.residualDegreeOfFreedom, <span class="st">"| DoF Null:"</span>, summary.residualDegreeOfFreedomNull)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Iterations:"</span>, summary.numIterations)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>pred_test <span class="op">=</span> glr_model.transform(test_df)  <span class="co"># requires test_df from split chunk</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>ev <span class="op">=</span> <span class="kw">lambda</span> m: RegressionEvaluator(labelCol<span class="op">=</span><span class="st">"SALARY"</span>, predictionCol<span class="op">=</span><span class="st">"prediction"</span>, metricName<span class="op">=</span>m)</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== TEST metrics ==="</span>)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"RMSE (test):"</span>, ev(<span class="st">"rmse"</span>).evaluate(pred_test))</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"MAE  (test):"</span>, ev(<span class="st">"mae"</span>).evaluate(pred_test))</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"R^2  (test):"</span>, ev(<span class="st">"r2"</span>).evaluate(pred_test))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
=== TRAIN metrics (GLR) ===
AIC: 450302.47117524507
Deviance: 22584582382859.082 | Null Deviance: 35794690345776.11
Dispersion: 1194825012.3192828
DoF Residual: 18902 | DoF Null: 18965
Iterations: 1

=== TEST metrics ===
RMSE (test): 35388.40947439649
MAE  (test): 27259.2717734521
R^2  (test): 0.3557348713590457</code></pre>
</div>
</div>
</section>
<section id="glr-summary" class="level1" data-number="10">
<h1 data-number="10"><span class="header-section-number">10</span> GLR Summary</h1>
<div id="2b561b73" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === GLR summary bundle ===</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np, pandas <span class="im">as</span> pd</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.evaluation <span class="im">import</span> RegressionEvaluator</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co"># If you already defined build_feature_names earlier, this will use it;</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co"># otherwise we fall back to assembler inputs (won't expand one-hot labels, but fine).</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _resolve_feature_names():</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> build_feature_names(vec_model, assembler_inputs, categorical_cols)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>        base_inputs <span class="op">=</span> assembler_inputs <span class="cf">if</span> <span class="st">'assembler_inputs'</span> <span class="kw">in</span> <span class="bu">globals</span>() <span class="cf">else</span> assembler.getInputCols()</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">list</span>(base_inputs)</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>feature_names <span class="op">=</span> _resolve_feature_names()</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Pull coefficient stats</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>coefs <span class="op">=</span> np.array(glr_model.coefficients.toArray())</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>se    <span class="op">=</span> np.array(summary.coefficientStandardErrors)</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>tvals <span class="op">=</span> np.array(summary.tValues)</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>pvals <span class="op">=</span> np.array(summary.pValues)</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="bu">min</span>(<span class="bu">len</span>(feature_names), <span class="bu">len</span>(coefs), <span class="bu">len</span>(se), <span class="bu">len</span>(tvals), <span class="bu">len</span>(pvals))</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>coef_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"feature"</span>: feature_names[:n],</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"coef"</span>:    coefs[:n],</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"std_err"</span>: se[:n],</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"t"</span>:       tvals[:n],</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p"</span>:       pvals[:n]</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>coef_df[<span class="st">"abs_t"</span>] <span class="op">=</span> coef_df[<span class="st">"t"</span>].<span class="bu">abs</span>()</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Top 12 by |t| (most statistically significant):"</span>)</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(coef_df.sort_values(<span class="st">"abs_t"</span>, ascending<span class="op">=</span><span class="va">False</span>).head(<span class="dv">12</span>).to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Largest positive effects (by coefficient):"</span>)</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(coef_df.sort_values(<span class="st">"coef"</span>, ascending<span class="op">=</span><span class="va">False</span>).head(<span class="dv">8</span>).to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Largest negative effects (by coefficient):"</span>)</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(coef_df.sort_values(<span class="st">"coef"</span>, ascending<span class="op">=</span><span class="va">True</span>).head(<span class="dv">8</span>).to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit metrics</span></span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>ev <span class="op">=</span> <span class="kw">lambda</span> m, df: RegressionEvaluator(labelCol<span class="op">=</span><span class="st">"SALARY"</span>, predictionCol<span class="op">=</span><span class="st">"prediction"</span>, metricName<span class="op">=</span>m).evaluate(glr_model.transform(df))</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>metrics <span class="op">=</span> {</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">"AIC"</span>: summary.aic,</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Deviance"</span>: summary.deviance,</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Null Deviance"</span>: summary.nullDeviance,</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Dispersion"</span>: summary.dispersion,</span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Train RMSE"</span>: ev(<span class="st">"rmse"</span>, train_df),</span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Train MAE"</span>:  ev(<span class="st">"mae"</span>,  train_df),</span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Train R2"</span>:   ev(<span class="st">"r2"</span>,   train_df),</span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Test RMSE"</span>:  ev(<span class="st">"rmse"</span>, test_df),</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Test MAE"</span>:   ev(<span class="st">"mae"</span>,  test_df),</span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Test R2"</span>:    ev(<span class="st">"r2"</span>,   test_df),</span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Intercept"</span>:  glr_model.intercept,</span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_features"</span>: glr_model.numFeatures,</span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_train"</span>:    train_df.count(),</span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_test"</span>:     test_df.count(),</span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== Fit summary ==="</span>)</span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k, v <span class="kw">in</span> metrics.items():</span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Feature set used:"</span>)</span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  Continuous:"</span>, continuous_cols <span class="cf">if</span> <span class="st">'continuous_cols'</span> <span class="kw">in</span> <span class="bu">globals</span>() <span class="cf">else</span> <span class="st">"&lt;unknown&gt;"</span>)</span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  Categorical:"</span>, categorical_cols <span class="cf">if</span> <span class="st">'categorical_cols'</span> <span class="kw">in</span> <span class="bu">globals</span>() <span class="cf">else</span> <span class="st">"&lt;unknown&gt;"</span>)</span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  Assembler order:"</span>, assembler_inputs <span class="cf">if</span> <span class="st">'assembler_inputs'</span> <span class="kw">in</span> <span class="bu">globals</span>() <span class="cf">else</span> <span class="st">"&lt;unknown&gt;"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Top 12 by |t| (most statistically significant):
                                        feature          coef       std_err         t        p     abs_t
                           MIN_YEARS_EXPERIENCE   7451.887786     83.326049 89.430471 0.000000 89.430471
                                 DURATION_LOG1P  -4931.651642   1510.974164 -3.263889 0.001101  3.263889
                                       DURATION    136.756559     64.316557  2.126304 0.033491  2.126304
                           MAX_YEARS_EXPERIENCE    494.046913    264.849720  1.865386 0.062143  1.865386
MIN_EDULEVELS_NAME=Ph.D. or professional degree  42589.194675 134939.556471  0.315617 0.752297  0.315617
          MIN_EDULEVELS_NAME=High school or GED -29036.032939 134935.665677 -0.215184 0.829626  0.215184
             MIN_EDULEVELS_NAME=Master's degree -27581.806726 134935.540518 -0.204407 0.838037  0.204407
                          STATE_NAME=New Mexico -15232.409644  97696.011927 -0.155916 0.876101  0.155916
                       STATE_NAME=West Virginia -14906.340925  97769.306507 -0.152464 0.878822  0.152464
                        STATE_NAME=South Dakota -11650.096634  97692.132393 -0.119253 0.905076  0.119253
                              STATE_NAME=Alaska -10426.259148  97698.314853 -0.106719 0.915013  0.106719
                         STATE_NAME=Mississippi  -9341.093065  97682.126606 -0.095627 0.923817  0.095627

Largest positive effects (by coefficient):
                                        feature         coef       std_err         t        p     abs_t
MIN_EDULEVELS_NAME=Ph.D. or professional degree 42589.194675 134939.556471  0.315617 0.752297  0.315617
                         STATE_NAME=Connecticut  8743.295702  97652.420135  0.089535 0.928658  0.089535
            MIN_EDULEVELS_NAME=Associate degree  8667.009651 134933.562407  0.064232 0.948786  0.064232
                           MIN_YEARS_EXPERIENCE  7451.887786     83.326049 89.430471 0.000000 89.430471
                          STATE_NAME=California  6901.863569  97632.983454  0.070692 0.943644  0.070692
         MIN_EDULEVELS_NAME=No Education Listed  5625.305974 134932.821347  0.041690 0.966747  0.041690
                          STATE_NAME=Washington  5543.590546  97640.601600  0.056775 0.954725  0.056775
                          STATE_NAME=New Jersey  3937.816625  97642.479514  0.040329 0.967831  0.040329

Largest negative effects (by coefficient):
                              feature          coef       std_err         t        p    abs_t
MIN_EDULEVELS_NAME=High school or GED -29036.032939 134935.665677 -0.215184 0.829626 0.215184
   MIN_EDULEVELS_NAME=Master's degree -27581.806726 134935.540518 -0.204407 0.838037 0.204407
                STATE_NAME=New Mexico -15232.409644  97696.011927 -0.155916 0.876101 0.155916
             STATE_NAME=West Virginia -14906.340925  97769.306507 -0.152464 0.878822 0.152464
              STATE_NAME=South Dakota -11650.096634  97692.132393 -0.119253 0.905076 0.119253
                    STATE_NAME=Alaska -10426.259148  97698.314853 -0.106719 0.915013 0.106719
               STATE_NAME=Mississippi  -9341.093065  97682.126606 -0.095627 0.923817 0.095627
                    STATE_NAME=Nevada  -8089.465051  97664.807954 -0.082829 0.933988 0.082829

=== Fit summary ===
AIC: 450302.47117524507
Deviance: 22584582382859.082
Null Deviance: 35794690345776.11
Dispersion: 1194825012.3192828
Train RMSE: 34507.8704592862
Train MAE: 26552.042063548983
Train R2: 0.3690521648688121
Test RMSE: 35388.40947439649
Test MAE: 27259.2717734521
Test R2: 0.3557348713590457
Intercept: 88399.58369934643
n_features: 63
n_train: 18966
n_test: 4731

Feature set used:
  Continuous: ['DURATION', 'MAX_YEARS_EXPERIENCE', 'DURATION_LOG1P']
  Categorical: ['STATE_NAME', 'MIN_EDULEVELS_NAME']
  Assembler order: ['MIN_YEARS_EXPERIENCE', 'DURATION', 'MAX_YEARS_EXPERIENCE', 'DURATION_LOG1P', 'STATE_NAME_vec', 'MIN_EDULEVELS_NAME_vec']</code></pre>
</div>
</div>
<p><strong><em>Linear Regression Model Explanation</em></strong> Using a GLR with gaussian/identity, the model explains roughly a third of salary variation (R² ≈ 0.36 test; RMSE ≈ $35k, MAE ≈ $26–27k), so it captures some signal but leaves substantial noise. The coefficient signs and magnitudes align with intuition: the MIN_YEARS_EXPERIENCE term is positive and statistically reliable with a large t-value and a very small p-value, implying salaries increase by about $7.5k per additional required year. DURATION_LOG1P is negative and significant, suggesting postings that stay open longer tend to offer lower salaries, even after controlling for other factors. MAX_YEARS_EXPERIENCE is positive but weaker. In contrast, most state and minimum education one-hot coefficients show large standard errors, small t-values, and high p-values; despite some large raw coefficients, these effects are not statistically distinguishable from zero in this sample. This pattern is consistent with high-cardinality dummies (many rare categories), sparse cells, and omitted drivers (role/seniority, company size, cost of living). Overall, the model finds clear, significant effects for experience and posting duration, while geography and education signals remain noisy. Further analysis on the effects of location and education levels would require more granular features to understand the entire picture.</p>
</section>
<section id="polynomial-regression-prep" class="level1" data-number="11">
<h1 data-number="11"><span class="header-section-number">11</span> Polynomial Regression Prep</h1>
<div id="b5fdb771" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> col, <span class="bu">pow</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.feature <span class="im">import</span> VectorAssembler</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.regression <span class="im">import</span> GeneralizedLinearRegression</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Safety: make sure train/test have features_poly; if not, create it from MIN_YEARS_EXPERIENCE</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>MINEXP_COL <span class="op">=</span> <span class="st">"MIN_YEARS_EXPERIENCE"</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"features_poly"</span> <span class="kw">not</span> <span class="kw">in</span> train_df.columns:</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    train_tmp <span class="op">=</span> train_df.withColumn(<span class="ss">f"</span><span class="sc">{</span>MINEXP_COL<span class="sc">}</span><span class="ss">_SQ"</span>, <span class="bu">pow</span>(col(MINEXP_COL), <span class="fl">2.0</span>))</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    poly_asm  <span class="op">=</span> VectorAssembler(inputCols<span class="op">=</span>[MINEXP_COL, <span class="ss">f"</span><span class="sc">{</span>MINEXP_COL<span class="sc">}</span><span class="ss">_SQ"</span>], outputCol<span class="op">=</span><span class="st">"features_poly"</span>)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    train_df  <span class="op">=</span> poly_asm.transform(train_tmp)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"features_poly"</span> <span class="kw">not</span> <span class="kw">in</span> test_df.columns:</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    test_tmp  <span class="op">=</span> test_df.withColumn(<span class="ss">f"</span><span class="sc">{</span>MINEXP_COL<span class="sc">}</span><span class="ss">_SQ"</span>, <span class="bu">pow</span>(col(MINEXP_COL), <span class="fl">2.0</span>))</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    poly_asm2 <span class="op">=</span> VectorAssembler(inputCols<span class="op">=</span>[MINEXP_COL, <span class="ss">f"</span><span class="sc">{</span>MINEXP_COL<span class="sc">}</span><span class="ss">_SQ"</span>], outputCol<span class="op">=</span><span class="st">"features_poly"</span>)</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    test_df   <span class="op">=</span> poly_asm2.transform(test_tmp)</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Train GLR using the polynomial feature vector (rename to 'features' for the estimator)</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>train_poly <span class="op">=</span> train_df.select(<span class="st">"SALARY"</span>, col(<span class="st">"features_poly"</span>).alias(<span class="st">"features"</span>))</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>test_poly  <span class="op">=</span> test_df.select(<span class="st">"SALARY"</span>, col(<span class="st">"features_poly"</span>).alias(<span class="st">"features"</span>))</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>glr_poly <span class="op">=</span> GeneralizedLinearRegression(</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    featuresCol<span class="op">=</span><span class="st">"features"</span>,</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>    labelCol<span class="op">=</span><span class="st">"SALARY"</span>,</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>    family<span class="op">=</span><span class="st">"gaussian"</span>,</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>    link<span class="op">=</span><span class="st">"identity"</span>,</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>    maxIter<span class="op">=</span><span class="dv">50</span>,</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>    regParam<span class="op">=</span><span class="fl">0.0</span>  <span class="co"># keep unregularized to mirror OLS</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>glr_poly_model <span class="op">=</span> glr_poly.fit(train_poly)</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>poly_summary   <span class="op">=</span> glr_poly_model.summary</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Poly model fitted."</span>)</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Intercept:"</span>, glr_poly_model.intercept, <span class="st">"| Num features:"</span>, glr_poly_model.numFeatures)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Poly model fitted.
Intercept: 70287.60251254399 | Num features: 2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>25/10/07 20:37:40 WARN Instrumentation: [b52411ed] regParam is zero, which might cause numerical instability and overfitting.</code></pre>
</div>
</div>
</section>
<section id="polynomial-coefficient-table" class="level1" data-number="12">
<h1 data-number="12"><span class="header-section-number">12</span> Polynomial Coefficient Table</h1>
<div id="b7bc2ebc" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np, pandas <span class="im">as</span> pd</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Feature names for the two polynomial terms (order matches the assembler we used)</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>poly_inputs <span class="op">=</span> [MINEXP_COL, <span class="ss">f"</span><span class="sc">{</span>MINEXP_COL<span class="sc">}</span><span class="ss">_SQ"</span>]</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>coefs <span class="op">=</span> np.array(glr_poly_model.coefficients.toArray())</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>se    <span class="op">=</span> np.array(poly_summary.coefficientStandardErrors)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>tvals <span class="op">=</span> np.array(poly_summary.tValues)</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>pvals <span class="op">=</span> np.array(poly_summary.pValues)</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="bu">min</span>(<span class="bu">len</span>(poly_inputs), <span class="bu">len</span>(coefs), <span class="bu">len</span>(se), <span class="bu">len</span>(tvals), <span class="bu">len</span>(pvals))</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>rows <span class="op">=</span> []</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    ci_low  <span class="op">=</span> coefs[i] <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> se[i]</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    ci_high <span class="op">=</span> coefs[i] <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> se[i]</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    rows.append([poly_inputs[i], coefs[i], se[i], tvals[i], pvals[i], ci_low, ci_high])</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>coef_poly_df <span class="op">=</span> pd.DataFrame(rows, columns<span class="op">=</span>[<span class="st">"feature"</span>,<span class="st">"coef"</span>,<span class="st">"std_err"</span>,<span class="st">"t_value"</span>,<span class="st">"p_value"</span>,<span class="st">"ci_low_95"</span>,<span class="st">"ci_high_95"</span>])</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== Polynomial coefficients ==="</span>)</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(coef_poly_df.to_string(index<span class="op">=</span><span class="va">False</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
=== Polynomial coefficients ===
                feature         coef    std_err    t_value  p_value    ci_low_95   ci_high_95
   MIN_YEARS_EXPERIENCE 12827.573079 291.527378  44.001264      0.0 12256.179419 13398.966739
MIN_YEARS_EXPERIENCE_SQ  -460.024211  20.730562 -22.190629      0.0  -500.656113  -419.392309</code></pre>
</div>
</div>
</section>
<section id="polynomial-metrics" class="level1" data-number="13">
<h1 data-number="13"><span class="header-section-number">13</span> Polynomial Metrics</h1>
<div id="b6b818a8" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.evaluation <span class="im">import</span> RegressionEvaluator</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Train metrics (GLR gives AIC/deviance; R²/RMSE/MAE via evaluator)</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== TRAIN metrics (polynomial) ==="</span>)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"AIC:"</span>, poly_summary.aic)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Deviance:"</span>, poly_summary.deviance, <span class="st">"| Null Deviance:"</span>, poly_summary.nullDeviance)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Dispersion:"</span>, poly_summary.dispersion)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>pred_train_poly <span class="op">=</span> glr_poly_model.transform(train_poly)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>pred_test_poly  <span class="op">=</span> glr_poly_model.transform(test_poly)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>ev <span class="op">=</span> <span class="kw">lambda</span> m, df: RegressionEvaluator(labelCol<span class="op">=</span><span class="st">"SALARY"</span>, predictionCol<span class="op">=</span><span class="st">"prediction"</span>, metricName<span class="op">=</span>m).evaluate(df)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"RMSE (train):"</span>, ev(<span class="st">"rmse"</span>, pred_train_poly))</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"MAE  (train):"</span>, ev(<span class="st">"mae"</span>,  pred_train_poly))</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"R^2  (train):"</span>, ev(<span class="st">"r2"</span>,   pred_train_poly))</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== TEST metrics (polynomial) ==="</span>)</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"RMSE (test):"</span>, ev(<span class="st">"rmse"</span>, pred_test_poly))</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"MAE  (test):"</span>, ev(<span class="st">"mae"</span>,  pred_test_poly))</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"R^2  (test):"</span>, ev(<span class="st">"r2"</span>,   pred_test_poly))</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Tiny interpretive aid (don’t assume sign—read from your printed table):</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>beta1 <span class="op">=</span> <span class="bu">float</span>(coefs[<span class="dv">0</span>]) <span class="cf">if</span> <span class="bu">len</span>(coefs)<span class="op">&gt;</span><span class="dv">0</span> <span class="cf">else</span> <span class="bu">float</span>(<span class="st">'nan'</span>)   <span class="co"># MIN_YEARS_EXPERIENCE</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>beta2 <span class="op">=</span> <span class="bu">float</span>(coefs[<span class="dv">1</span>]) <span class="cf">if</span> <span class="bu">len</span>(coefs)<span class="op">&gt;</span><span class="dv">1</span> <span class="cf">else</span> <span class="bu">float</span>(<span class="st">'nan'</span>)   <span class="co"># MIN_YEARS_EXPERIENCE_SQ</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>shape <span class="op">=</span> <span class="st">"concave (diminishing returns)"</span> <span class="cf">if</span> beta2 <span class="op">&lt;</span> <span class="dv">0</span> <span class="cf">else</span> (<span class="st">"convex (accelerating returns)"</span> <span class="cf">if</span> beta2 <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">"approximately linear"</span>)</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Shape hint: with β2 = </span><span class="sc">{</span>beta2<span class="sc">:.4g}</span><span class="ss">, the salary–experience curve is </span><span class="sc">{</span>shape<span class="sc">}</span><span class="ss">."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
=== TRAIN metrics (polynomial) ===
AIC: 452747.98836473195
Deviance: 25858573546515.664 | Null Deviance: 35794690345776.11
Dispersion: 1363633051.0212343
RMSE (train): 36924.48177776293
MAE  (train): 28266.03414348427
R^2  (train): 0.277586332030762

=== TEST metrics (polynomial) ===
RMSE (test): 37564.74122137758
MAE  (test): 28688.439293686028
R^2  (test): 0.2740556313615262

Shape hint: with β2 = -460, the salary–experience curve is concave (diminishing returns).</code></pre>
</div>
</div>
<p><strong><em>Polynomial Regression Model Explanation</em></strong> The polynomial GLR (gaussian/identity) was fit on features_poly = [MIN_YEARS_EXPERIENCE, MIN_YEARS_EXPERIENCE^2]. Out-of-sample performance is modest: RMSE ≈ 37.6k, MAE ≈ 28.7k, and R² ≈ 0.275 on the test set (train: RMSE ≈ 36.9k, MAE ≈ 28.3k, R² ≈ 0.278). The model fit metrics are consistent with the linear model and slightly worse (AIC 452,747 vs ~450,302 for the linear run), indicating the quadratic term does not add predictive signal given the current features. Coefficient estimates from the GLR summary show a positive linear effect of experience and a negative quadratic term since β₂ &lt; 0 and this model returned -460, implying a concave salary–experience curve where salary rises with experience, with the marginal gain per extra year diminishing at higher experience levels. Standard errors, t-values, and p-values from the summary quantify reliability of these effects as the linear term is typically significant, while the quadratic term’s significance should be read directly from the printed table. Overall, most variance in salary remains unexplained by experience alone and the two categorical controls used previously, which is consistent with compensation being driven by many factors (role/level, company, skills, location specifics, benefits, etc.). If this were being investigated further, reasonable next steps would be to center experience before squaring to reduce multicollinearity and stabilize inference and to incorporate richer features (job title/seniority, industry, skills) to understand the entire picture.</p>
</section>
<section id="random-forest-regressor" class="level1" data-number="14">
<h1 data-number="14"><span class="header-section-number">14</span> Random Forest Regressor</h1>
<div id="bda2ec51" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === Random Forest Regressor (features) ===</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Uses: train_df, test_df with columns ["features", "SALARY"]</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.regression <span class="im">import</span> RandomForestRegressor</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.evaluation <span class="im">import</span> RegressionEvaluator</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> col</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np, pandas <span class="im">as</span> pd</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Safety checks</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> [<span class="st">"features"</span>, <span class="st">"SALARY"</span>]:</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> c <span class="kw">in</span> train_df.columns, <span class="ss">f"Missing column '</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">' in train_df"</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> c <span class="kw">in</span> test_df.columns,  <span class="ss">f"Missing column '</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">' in test_df"</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Hyperparameters (pick within the asked ranges)</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>rf <span class="op">=</span> RandomForestRegressor(</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    featuresCol<span class="op">=</span><span class="st">"features"</span>,</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    labelCol<span class="op">=</span><span class="st">"SALARY"</span>,</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    numTrees<span class="op">=</span><span class="dv">200</span>,         <span class="co"># 100–500</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    maxDepth<span class="op">=</span><span class="dv">8</span>,           <span class="co"># 4–10</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>    featureSubsetStrategy<span class="op">=</span><span class="st">"auto"</span>,</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>    seed<span class="op">=</span><span class="dv">42</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>rf_model <span class="op">=</span> rf.fit(train_df)</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>pred_train <span class="op">=</span> rf_model.transform(train_df)</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>pred_test  <span class="op">=</span> rf_model.transform(test_df)</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Metrics helpers</span></span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>ev <span class="op">=</span> <span class="kw">lambda</span> m, df: RegressionEvaluator(</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>    labelCol<span class="op">=</span><span class="st">"SALARY"</span>, predictionCol<span class="op">=</span><span class="st">"prediction"</span>, metricName<span class="op">=</span>m</span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>).evaluate(df)</span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"=== Random Forest — Train/Test metrics ==="</span>)</span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Num trees: </span><span class="sc">{</span>rf<span class="sc">.</span>getNumTrees<span class="sc">}</span><span class="ss"> | Max depth: </span><span class="sc">{</span>rf<span class="sc">.</span>getMaxDepth()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">-- TRAIN --"</span>)</span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"RMSE:"</span>, ev(<span class="st">"rmse"</span>, pred_train))</span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"MAE :"</span>, ev(<span class="st">"mae"</span>,  pred_train))</span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"R^2 :"</span>, ev(<span class="st">"r2"</span>,   pred_train))</span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">-- TEST --"</span>)</span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"RMSE:"</span>, ev(<span class="st">"rmse"</span>, pred_test))</span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"MAE :"</span>, ev(<span class="st">"mae"</span>,  pred_test))</span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"R^2 :"</span>, ev(<span class="st">"r2"</span>,   pred_test))</span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------- Top feature importances (robust naming) ----------</span></span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> names_from_vector_metadata(df, colname<span class="op">=</span><span class="st">"features"</span>):</span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Try to read attribute names from Spark vector metadata."""</span></span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a>        ml_attr <span class="op">=</span> df.schema[colname].metadata.get(<span class="st">"ml_attr"</span>, {})</span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true" tabindex="-1"></a>        attrs <span class="op">=</span> ml_attr.get(<span class="st">"attrs"</span>, {})</span>
<span id="cb34-54"><a href="#cb34-54" aria-hidden="true" tabindex="-1"></a>        pairs <span class="op">=</span> []</span>
<span id="cb34-55"><a href="#cb34-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> k <span class="kw">in</span> (<span class="st">"binary"</span>, <span class="st">"numeric"</span>, <span class="st">"nominal"</span>):</span>
<span id="cb34-56"><a href="#cb34-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> a <span class="kw">in</span> attrs.get(k, []):</span>
<span id="cb34-57"><a href="#cb34-57" aria-hidden="true" tabindex="-1"></a>                pairs.append((a[<span class="st">"idx"</span>], a[<span class="st">"name"</span>]))</span>
<span id="cb34-58"><a href="#cb34-58" aria-hidden="true" tabindex="-1"></a>        pairs.sort(key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">0</span>])</span>
<span id="cb34-59"><a href="#cb34-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [name <span class="cf">for</span> _, name <span class="kw">in</span> pairs]</span>
<span id="cb34-60"><a href="#cb34-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb34-61"><a href="#cb34-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb34-62"><a href="#cb34-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-63"><a href="#cb34-63" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Best source: vector metadata on training frame</span></span>
<span id="cb34-64"><a href="#cb34-64" aria-hidden="true" tabindex="-1"></a>feat_names <span class="op">=</span> names_from_vector_metadata(train_df, <span class="st">"features"</span>)</span>
<span id="cb34-65"><a href="#cb34-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-66"><a href="#cb34-66" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Fallback: if you have a pipeline + helper from the GLR section</span></span>
<span id="cb34-67"><a href="#cb34-67" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="kw">not</span> feat_names) <span class="kw">and</span> <span class="st">'vec_model'</span> <span class="kw">in</span> <span class="bu">globals</span>():</span>
<span id="cb34-68"><a href="#cb34-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'assembler_inputs'</span> <span class="kw">in</span> <span class="bu">globals</span>():</span>
<span id="cb34-69"><a href="#cb34-69" aria-hidden="true" tabindex="-1"></a>        base_inputs <span class="op">=</span> assembler_inputs</span>
<span id="cb34-70"><a href="#cb34-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">'assembler'</span> <span class="kw">in</span> <span class="bu">globals</span>():</span>
<span id="cb34-71"><a href="#cb34-71" aria-hidden="true" tabindex="-1"></a>        base_inputs <span class="op">=</span> assembler.getInputCols()</span>
<span id="cb34-72"><a href="#cb34-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb34-73"><a href="#cb34-73" aria-hidden="true" tabindex="-1"></a>        base_inputs <span class="op">=</span> []</span>
<span id="cb34-74"><a href="#cb34-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> base_inputs <span class="kw">and</span> <span class="st">'categorical_cols'</span> <span class="kw">in</span> <span class="bu">globals</span>() <span class="kw">and</span> <span class="st">'build_feature_names'</span> <span class="kw">in</span> <span class="bu">globals</span>():</span>
<span id="cb34-75"><a href="#cb34-75" aria-hidden="true" tabindex="-1"></a>        feat_names <span class="op">=</span> build_feature_names(vec_model, base_inputs, categorical_cols)</span>
<span id="cb34-76"><a href="#cb34-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-77"><a href="#cb34-77" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Final fallback: generic names; force length to match model</span></span>
<span id="cb34-78"><a href="#cb34-78" aria-hidden="true" tabindex="-1"></a>num_feats <span class="op">=</span> rf_model.numFeatures</span>
<span id="cb34-79"><a href="#cb34-79" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> feat_names <span class="kw">or</span> <span class="bu">len</span>(feat_names) <span class="op">!=</span> num_feats:</span>
<span id="cb34-80"><a href="#cb34-80" aria-hidden="true" tabindex="-1"></a>    feat_names <span class="op">=</span> (feat_names <span class="kw">or</span> [])</span>
<span id="cb34-81"><a href="#cb34-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(feat_names) <span class="op">&lt;</span> num_feats:</span>
<span id="cb34-82"><a href="#cb34-82" aria-hidden="true" tabindex="-1"></a>        feat_names <span class="op">+=</span> [<span class="ss">f"f</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(feat_names), num_feats)]</span>
<span id="cb34-83"><a href="#cb34-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb34-84"><a href="#cb34-84" aria-hidden="true" tabindex="-1"></a>        feat_names <span class="op">=</span> feat_names[:num_feats]</span>
<span id="cb34-85"><a href="#cb34-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-86"><a href="#cb34-86" aria-hidden="true" tabindex="-1"></a><span class="co"># Assemble importance table</span></span>
<span id="cb34-87"><a href="#cb34-87" aria-hidden="true" tabindex="-1"></a>imps <span class="op">=</span> np.array(rf_model.featureImportances.toArray())</span>
<span id="cb34-88"><a href="#cb34-88" aria-hidden="true" tabindex="-1"></a>k <span class="op">=</span> <span class="bu">min</span>(<span class="dv">20</span>, <span class="bu">len</span>(imps))</span>
<span id="cb34-89"><a href="#cb34-89" aria-hidden="true" tabindex="-1"></a>top_idx <span class="op">=</span> np.argsort(<span class="op">-</span>imps)[:k]</span>
<span id="cb34-90"><a href="#cb34-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-91"><a href="#cb34-91" aria-hidden="true" tabindex="-1"></a>imp_df <span class="op">=</span> (</span>
<span id="cb34-92"><a href="#cb34-92" aria-hidden="true" tabindex="-1"></a>    pd.DataFrame({<span class="st">"feature"</span>: [feat_names[i] <span class="cf">for</span> i <span class="kw">in</span> top_idx],</span>
<span id="cb34-93"><a href="#cb34-93" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"importance"</span>: imps[top_idx]})</span>
<span id="cb34-94"><a href="#cb34-94" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">"importance"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb34-95"><a href="#cb34-95" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-96"><a href="#cb34-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-97"><a href="#cb34-97" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== Top feature importances (RF) ==="</span>)</span>
<span id="cb34-98"><a href="#cb34-98" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(imp_df.to_string(index<span class="op">=</span><span class="va">False</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 279:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 281:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 283:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 285:&gt;                                                        (0 + 1) / 1]                                                                                25/10/07 20:37:47 WARN DAGScheduler: Broadcasting large task binary with size 1326.7 KiB
[Stage 287:&gt;                                                        (0 + 1) / 1]                                                                                25/10/07 20:37:51 WARN DAGScheduler: Broadcasting large task binary with size 2.2 MiB
[Stage 289:&gt;                                                        (0 + 1) / 1][Stage 290:&gt;                                                        (0 + 1) / 1]                                                                                25/10/07 20:37:55 WARN DAGScheduler: Broadcasting large task binary with size 3.6 MiB
[Stage 291:&gt;                                                        (0 + 1) / 1][Stage 292:&gt;                                                        (0 + 1) / 1]                                                                                25/10/07 20:38:00 WARN DAGScheduler: Broadcasting large task binary with size 5.8 MiB
[Stage 293:&gt;                                                        (0 + 1) / 1]25/10/07 20:38:05 WARN DAGScheduler: Broadcasting large task binary with size 1047.7 KiB
[Stage 294:&gt;                                                        (0 + 1) / 1]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=== Random Forest — Train/Test metrics ===
Num trees: &lt;bound method _RandomForestParams.getNumTrees of RandomForestRegressor_af1d676f0d17&gt; | Max depth: 8

-- TRAIN --</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 295:&gt;                                                        (0 + 1) / 1]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>RMSE: 32657.1265678504</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 296:&gt;                                                        (0 + 1) / 1]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>MAE : 24939.575590404347</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 297:&gt;                                                        (0 + 1) / 1]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>R^2 : 0.4349159159311694

-- TEST --
RMSE: 34129.60377248678
MAE : 25958.80877270425
R^2 : 0.40075415615336374

=== Top feature importances (RF) ===
                                            feature  importance
                               MIN_YEARS_EXPERIENCE    0.655082
          MIN_EDULEVELS_NAME_vec_High school or GED    0.109038
             MIN_EDULEVELS_NAME_vec_Master's degree    0.058031
                               MAX_YEARS_EXPERIENCE    0.051498
                                           DURATION    0.020948
            MIN_EDULEVELS_NAME_vec_Associate degree    0.017925
           MIN_EDULEVELS_NAME_vec_Bachelor's degree    0.015904
                                     DURATION_LOG1P    0.014252
         MIN_EDULEVELS_NAME_vec_No Education Listed    0.010687
                          STATE_NAME_vec_California    0.007109
                            STATE_NAME_vec_New York    0.005317
                              STATE_NAME_vec_Oregon    0.004490
                              STATE_NAME_vec_Nevada    0.002779
                               STATE_NAME_vec_Texas    0.001564
MIN_EDULEVELS_NAME_vec_Ph.D. or professional degree    0.001499
                            STATE_NAME_vec_Illinois    0.001495
                           STATE_NAME_vec_Minnesota    0.001411
                            STATE_NAME_vec_Michigan    0.001251
                          STATE_NAME_vec_New Jersey    0.001058
                          STATE_NAME_vec_New Mexico    0.001022</code></pre>
</div>
</div>
</section>
<section id="feature-importance-plot" class="level1" data-number="15">
<h1 data-number="15"><span class="header-section-number">15</span> Feature Importance Plot</h1>
<div id="80564d5a" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === 6.1 Feature Importance Plot (Seaborn) ===</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Requires: rf_model, train_df (for feature metadata), and optionally:</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co">#           feat_names or build_feature_names()/assembler_inputs/vec_model</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np, pandas <span class="im">as</span> pd</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="co"># -- recover feature names if needed --</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> names_from_vector_metadata(df, colname<span class="op">=</span><span class="st">"features"</span>):</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>        ml_attr <span class="op">=</span> df.schema[colname].metadata.get(<span class="st">"ml_attr"</span>, {})</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>        attrs <span class="op">=</span> ml_attr.get(<span class="st">"attrs"</span>, {})</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>        pairs <span class="op">=</span> []</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> k <span class="kw">in</span> (<span class="st">"binary"</span>, <span class="st">"numeric"</span>, <span class="st">"nominal"</span>):</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> a <span class="kw">in</span> attrs.get(k, []):</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>                pairs.append((a[<span class="st">"idx"</span>], a[<span class="st">"name"</span>]))</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>        pairs.sort(key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">0</span>])</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [name <span class="cf">for</span> _, name <span class="kw">in</span> pairs]</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'feat_names'</span> <span class="kw">not</span> <span class="kw">in</span> <span class="bu">globals</span>() <span class="kw">or</span> <span class="kw">not</span> feat_names:</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>    feat_names <span class="op">=</span> names_from_vector_metadata(train_df, <span class="st">"features"</span>)</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">not</span> feat_names) <span class="kw">and</span> <span class="st">'vec_model'</span> <span class="kw">in</span> <span class="bu">globals</span>():</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'assembler_inputs'</span> <span class="kw">in</span> <span class="bu">globals</span>():</span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>            base_inputs <span class="op">=</span> assembler_inputs</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="st">'assembler'</span> <span class="kw">in</span> <span class="bu">globals</span>():</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>            base_inputs <span class="op">=</span> assembler.getInputCols()</span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>            base_inputs <span class="op">=</span> []</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> base_inputs <span class="kw">and</span> <span class="st">'categorical_cols'</span> <span class="kw">in</span> <span class="bu">globals</span>() <span class="kw">and</span> <span class="st">'build_feature_names'</span> <span class="kw">in</span> <span class="bu">globals</span>():</span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>            feat_names <span class="op">=</span> build_feature_names(vec_model, base_inputs, categorical_cols)</span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a><span class="co"># final fallback to generic names</span></span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>num_feats <span class="op">=</span> rf_model.numFeatures</span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> feat_names <span class="kw">or</span> <span class="bu">len</span>(feat_names) <span class="op">!=</span> num_feats:</span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>    feat_names <span class="op">=</span> (feat_names <span class="kw">or</span> [])</span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(feat_names) <span class="op">&lt;</span> num_feats:</span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>        feat_names <span class="op">+=</span> [<span class="ss">f"f</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(feat_names), num_feats)]</span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a>        feat_names <span class="op">=</span> feat_names[:num_feats]</span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a><span class="co"># -- assemble importance DataFrame if needed --</span></span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'imp_df'</span> <span class="kw">not</span> <span class="kw">in</span> <span class="bu">globals</span>():</span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a>    imps <span class="op">=</span> np.array(rf_model.featureImportances.toArray())</span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a>    imp_df <span class="op">=</span> pd.DataFrame({<span class="st">"feature"</span>: feat_names, <span class="st">"importance"</span>: imps})</span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Top 10 (descending)</span></span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a>top10 <span class="op">=</span> imp_df.sort_values(<span class="st">"importance"</span>, ascending<span class="op">=</span><span class="va">False</span>).head(<span class="dv">10</span>)</span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a>top10 <span class="op">=</span> top10.iloc[::<span class="op">-</span><span class="dv">1</span>]  <span class="co"># reverse for horizontal plot (largest at top)</span></span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-54"><a href="#cb43-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb43-55"><a href="#cb43-55" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb43-56"><a href="#cb43-56" aria-hidden="true" tabindex="-1"></a>sns.barplot(data<span class="op">=</span>top10, x<span class="op">=</span><span class="st">"importance"</span>, y<span class="op">=</span><span class="st">"feature"</span>)</span>
<span id="cb43-57"><a href="#cb43-57" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Importance"</span>)</span>
<span id="cb43-58"><a href="#cb43-58" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Feature"</span>)</span>
<span id="cb43-59"><a href="#cb43-59" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Random Forest — Top 10 Feature Importances"</span>)</span>
<span id="cb43-60"><a href="#cb43-60" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb43-61"><a href="#cb43-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-62"><a href="#cb43-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Save</span></span>
<span id="cb43-63"><a href="#cb43-63" aria-hidden="true" tabindex="-1"></a>out_dir <span class="op">=</span> Path(<span class="st">"output"</span>)<span class="op">;</span> out_dir.mkdir(exist_ok<span class="op">=</span><span class="va">True</span>, parents<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-64"><a href="#cb43-64" aria-hidden="true" tabindex="-1"></a>out_path <span class="op">=</span> out_dir <span class="op">/</span> <span class="st">"rf_feature_importance.png"</span></span>
<span id="cb43-65"><a href="#cb43-65" aria-hidden="true" tabindex="-1"></a>plt.savefig(out_path, dpi<span class="op">=</span><span class="dv">200</span>, bbox_inches<span class="op">=</span><span class="st">"tight"</span>)</span>
<span id="cb43-66"><a href="#cb43-66" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb43-67"><a href="#cb43-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-68"><a href="#cb43-68" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Saved feature importance plot to: </span><span class="sc">{</span>out_path<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="assignment04-makenziehoward_files/figure-html/cell-16-output-1.png" width="757" height="470" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved feature importance plot to: output/rf_feature_importance.png</code></pre>
</div>
</div>
</section>
<section id="glr-polynomial-and-random-forest-comparison-prep" class="level1" data-number="16">
<h1 data-number="16"><span class="header-section-number">16</span> GLR, Polynomial, and Random Forest Comparison Prep</h1>
<div id="c7b964b3" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> col</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="st">'data_exact'</span> <span class="kw">in</span> <span class="bu">globals</span>(), <span class="st">"Run your feature-engineering chunk that creates `data_exact`."</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> (<span class="st">"features"</span>, <span class="st">"features_poly"</span>, <span class="st">"SALARY"</span>):</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> c <span class="kw">in</span> data_exact.columns, <span class="ss">f"`data_exact` is missing </span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">. Re-run feature assembly."</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'train_df'</span> <span class="kw">not</span> <span class="kw">in</span> <span class="bu">globals</span>() <span class="kw">or</span> <span class="st">'test_df'</span> <span class="kw">not</span> <span class="kw">in</span> <span class="bu">globals</span>():</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"No split found — creating an 80/20 split now (seed=42)."</span>)</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    train_df, test_df <span class="op">=</span> data_exact.randomSplit([<span class="fl">0.8</span>, <span class="fl">0.2</span>], seed<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    train_df.cache()<span class="op">;</span> test_df.cache()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="train-polynomial-glr" class="level1" data-number="17">
<h1 data-number="17"><span class="header-section-number">17</span> Train Polynomial GLR</h1>
<div id="837f1850" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.regression <span class="im">import</span> GeneralizedLinearRegression</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>train_poly_df <span class="op">=</span> train_df.select(<span class="st">"SALARY"</span>, <span class="st">"features_poly"</span>)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>test_poly_df  <span class="op">=</span> test_df.select(<span class="st">"SALARY"</span>, <span class="st">"features_poly"</span>)</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>poly_glr <span class="op">=</span> GeneralizedLinearRegression(</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    featuresCol<span class="op">=</span><span class="st">"features_poly"</span>,</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    labelCol<span class="op">=</span><span class="st">"SALARY"</span>,</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>    family<span class="op">=</span><span class="st">"gaussian"</span>,</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    link<span class="op">=</span><span class="st">"identity"</span>,</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>    maxIter<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>    regParam<span class="op">=</span><span class="fl">0.3</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>poly_model   <span class="op">=</span> poly_glr.fit(train_poly_df)</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>poly_summary <span class="op">=</span> poly_model.summary</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Polynomial GLR ready. #params:"</span>, poly_model.numFeatures <span class="op">+</span> <span class="dv">1</span>, <span class="st">"(including intercept)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Polynomial GLR ready. #params: 3 (including intercept)</code></pre>
</div>
</div>
</section>
<section id="compare-glr-vs-polynomial-vs-rf" class="level1" data-number="18">
<h1 data-number="18"><span class="header-section-number">18</span> Compare GLR vs Polynomial vs RF</h1>
<div id="6c486202" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> col</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.evaluation <span class="im">import</span> RegressionEvaluator</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> v <span class="kw">in</span> [<span class="st">"glr_model"</span>, <span class="st">"poly_model"</span>, <span class="st">"rf_model"</span>, <span class="st">"test_df"</span>]:</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> v <span class="kw">not</span> <span class="kw">in</span> <span class="bu">globals</span>():</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Missing </span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">. Train models first."</span>)</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>pred_glr  <span class="op">=</span> glr_model.transform(test_df).select(<span class="st">"SALARY"</span>, col(<span class="st">"prediction"</span>).alias(<span class="st">"pred_glr"</span>))</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>pred_poly <span class="op">=</span> poly_model.transform(test_df).select(<span class="st">"SALARY"</span>, col(<span class="st">"prediction"</span>).alias(<span class="st">"pred_poly"</span>))</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>pred_rf   <span class="op">=</span> rf_model.transform(test_df).select(<span class="st">"SALARY"</span>, col(<span class="st">"prediction"</span>).alias(<span class="st">"pred_rf"</span>))</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>wide <span class="op">=</span> (pred_glr</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>        .join(pred_poly, on<span class="op">=</span>[<span class="st">"SALARY"</span>], how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>        .join(pred_rf,   on<span class="op">=</span>[<span class="st">"SALARY"</span>], how<span class="op">=</span><span class="st">"inner"</span>))</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Metrics helpers</span></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pair_metrics(df, pred_col):</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"rmse"</span>: RegressionEvaluator(labelCol<span class="op">=</span><span class="st">"SALARY"</span>, predictionCol<span class="op">=</span>pred_col, metricName<span class="op">=</span><span class="st">"rmse"</span>).evaluate(df),</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"mae"</span> : RegressionEvaluator(labelCol<span class="op">=</span><span class="st">"SALARY"</span>, predictionCol<span class="op">=</span>pred_col, metricName<span class="op">=</span><span class="st">"mae"</span>).evaluate(df),</span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>m_glr  <span class="op">=</span> pair_metrics(pred_glr.withColumnRenamed(<span class="st">"pred_glr"</span>,  <span class="st">"prediction"</span>), <span class="st">"prediction"</span>)</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>m_poly <span class="op">=</span> pair_metrics(pred_poly.withColumnRenamed(<span class="st">"pred_poly"</span>,<span class="st">"prediction"</span>), <span class="st">"prediction"</span>)</span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>m_rf   <span class="op">=</span> pair_metrics(pred_rf.withColumnRenamed(<span class="st">"pred_rf"</span>,    <span class="st">"prediction"</span>), <span class="st">"prediction"</span>)</span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a><span class="co"># AIC/BIC for GLR models only</span></span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> loglik_from_summary(summary, n):</span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span><span class="fl">0.5</span> <span class="op">*</span> ( n<span class="op">*</span>math.log(<span class="dv">2</span><span class="op">*</span>math.pi) <span class="op">+</span> n<span class="op">*</span>math.log(summary.dispersion) <span class="op">+</span> summary.deviance<span class="op">/</span>summary.dispersion )</span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'summary'</span> <span class="kw">not</span> <span class="kw">in</span> <span class="bu">globals</span>():</span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>    summary <span class="op">=</span> glr_model.summary</span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a>n_train <span class="op">=</span> summary.numInstances</span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a>k_glr   <span class="op">=</span> glr_model.numFeatures <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a>ll_glr  <span class="op">=</span> loglik_from_summary(summary, n_train)</span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a>bic_glr <span class="op">=</span> k_glr<span class="op">*</span>math.log(n_train) <span class="op">-</span> <span class="dv">2</span><span class="op">*</span>ll_glr</span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a>aic_glr <span class="op">=</span> summary.aic</span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a>n_train_poly <span class="op">=</span> poly_summary.numInstances</span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a>k_poly       <span class="op">=</span> poly_model.numFeatures <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a>ll_poly      <span class="op">=</span> loglik_from_summary(poly_summary, n_train_poly)</span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a>bic_poly     <span class="op">=</span> k_poly<span class="op">*</span>math.log(n_train_poly) <span class="op">-</span> <span class="dv">2</span><span class="op">*</span>ll_poly</span>
<span id="cb48-47"><a href="#cb48-47" aria-hidden="true" tabindex="-1"></a>aic_poly     <span class="op">=</span> poly_summary.aic</span>
<span id="cb48-48"><a href="#cb48-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-49"><a href="#cb48-49" aria-hidden="true" tabindex="-1"></a>compare_df <span class="op">=</span> pd.DataFrame([</span>
<span id="cb48-50"><a href="#cb48-50" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"GLR (linear)"</span>,       m_glr[<span class="st">"rmse"</span>],  m_glr[<span class="st">"mae"</span>],  aic_glr,  bic_glr],</span>
<span id="cb48-51"><a href="#cb48-51" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Polynomial (GLR^2)"</span>, m_poly[<span class="st">"rmse"</span>], m_poly[<span class="st">"mae"</span>], aic_poly, bic_poly],</span>
<span id="cb48-52"><a href="#cb48-52" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Random Forest"</span>,      m_rf[<span class="st">"rmse"</span>],   m_rf[<span class="st">"mae"</span>],   <span class="va">None</span>,     <span class="va">None</span>],</span>
<span id="cb48-53"><a href="#cb48-53" aria-hidden="true" tabindex="-1"></a>], columns<span class="op">=</span>[<span class="st">"model"</span>,<span class="st">"rmse"</span>,<span class="st">"mae"</span>,<span class="st">"aic (train)"</span>,<span class="st">"bic (train)"</span>])</span>
<span id="cb48-54"><a href="#cb48-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-55"><a href="#cb48-55" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(compare_df.to_string(index<span class="op">=</span><span class="va">False</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>             model         rmse          mae   aic (train)   bic (train)
      GLR (linear) 35388.409474 27259.271773 450302.471175 450803.005205
Polynomial (GLR^2) 37564.678045 28688.460118 452747.988401 452769.539847
     Random Forest 34129.603772 25958.808773           NaN           NaN</code></pre>
</div>
</div>
</section>
<section id="glr-polynomial-and-random-forest-comparison-plot" class="level1" data-number="19">
<h1 data-number="19"><span class="header-section-number">19</span> GLR, Polynomial, and Random Forest Comparison Plot</h1>
<div id="102a4fc0" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2×2 grid with ONLY the three model scatter plots (GLR, Poly, RF) ---</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os, seaborn <span class="im">as</span> sns, matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>os.makedirs(<span class="st">"_output"</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>pdf <span class="op">=</span> wide.toPandas()</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(pdf) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"No rows in prediction frame; ensure glr_model/poly_model/rf_model were trained and predictions joined."</span>)</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="co"># safe downsample for readability</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>n_sample <span class="op">=</span> <span class="bu">min</span>(<span class="dv">5000</span>, <span class="bu">len</span>(pdf))</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>plot_df <span class="op">=</span> pdf.sample(n<span class="op">=</span>n_sample, random_state<span class="op">=</span><span class="dv">42</span>) <span class="cf">if</span> <span class="bu">len</span>(pdf) <span class="op">&gt;</span> n_sample <span class="cf">else</span> pdf</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">10</span>))</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes.ravel()</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>plots <span class="op">=</span> [</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"GLR: Actual vs Predicted"</span>,              <span class="st">"pred_glr"</span>),</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"Polynomial (GLR^2): Actual vs Pred."</span>,   <span class="st">"pred_poly"</span>),</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"Random Forest: Actual vs Predicted"</span>,    <span class="st">"pred_rf"</span>),</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (title, ycol) <span class="kw">in</span> <span class="bu">enumerate</span>(plots):</span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>    sns.scatterplot(data<span class="op">=</span>plot_df, x<span class="op">=</span><span class="st">"SALARY"</span>, y<span class="op">=</span>ycol, s<span class="op">=</span><span class="dv">12</span>, ax<span class="op">=</span>ax[i])</span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>    ax[i].set_title(title)</span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>    ax[i].set_xlabel(<span class="st">"Actual SALARY"</span>)</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>    ax[i].set_ylabel(<span class="st">"Predicted"</span>)</span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a><span class="co"># leave the 4th quadrant empty to keep a 2×2 layout</span></span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">3</span>].axis(<span class="st">"off"</span>)</span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>out_path <span class="op">=</span> <span class="st">"output/compare_actual_vs_pred_2x2.png"</span></span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a>plt.savefig(out_path, dpi<span class="op">=</span><span class="dv">160</span>, bbox_inches<span class="op">=</span><span class="st">"tight"</span>)</span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Saved:"</span>, out_path)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 314:&gt;                                                        (0 + 1) / 1]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="assignment04-makenziehoward_files/figure-html/cell-20-output-2.png" width="1142" height="950" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved: output/compare_actual_vs_pred_2x2.png</code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>